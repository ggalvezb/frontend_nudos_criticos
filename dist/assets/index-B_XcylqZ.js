import{V as de,a as ue,b as ce,c as y,d as Y,e as F,f as T,g as L,h as j,i as G,j as fe,u as O,w as me}from"./VTextarea-ChtcVcc_.js";import{_ as Ce,e as b,g as pe,V as ve,a as B,b as h,d as M,c as J,h as ge,i as _e,j as ye,f as Ve}from"./VTextField-CAdcEd-D.js";import{r as p,g as z,h as Ee,i as Ne,c as g,o as f,w as l,b as o,f as d,d as c,j as k,k as $,F as I,l as q,t as N}from"./index-Cfbqr0v8.js";const be={class:"mb-4"},he={class:"mb-4"},De={class:"lista-scroll"},we={class:"d-flex justify-space-between align-center"},Se={class:"mb-4"},xe={class:"mb-4"},Ae={class:"text-subtitle-1"},Fe={class:"lista-scroll"},Te={__name:"Inicio",setup(H){const V="https://backend-nudos-criticos-eadacb96aa89.herokuapp.com";function P(a){if(!a)return"";if(/^\d{2}-\d{2}-\d{4}$/.test(a)){const[t,m,_]=a.split("-");return`${_}-${m}-${t}`}const s=new Date(a.replaceAll("/","-"));return isNaN(s.getTime())?a:s.toISOString().slice(0,10)}async function K(){try{const a=await fetch(`${V}/proyecto/`);if(!a.ok)throw new Error(`Error obteniendo BD: ${a.status} ${a.statusText}`);const e=await a.json(),s=[];for(const r of e){const v=Array.isArray(r.Nudo_Critico)?r.Nudo_Critico:[];if(v.length===0)s.push({id_proyecto:r.id??"",Codigo:r.Codigo??"",Nombre_Proyecto:r.Nombre_Proyecto??"",Decreto:r.Decreto??"",Monitor:r.Monitor??"",id_nudo:"",Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:"",Fecha_Cierre:""});else for(const C of v)s.push({id_proyecto:r.id??"",Codigo:r.Codigo??"",Nombre_Proyecto:r.Nombre_Proyecto??"",Decreto:r.Decreto??"",Monitor:r.Monitor??"",id_nudo:C.id_nudo??"",Estado:C.Estado??"",Clasificacion:C.Clasificacion??"",Descripcion:C.Descripcion??"",Fecha_Creacion:P(C.Fecha_Creacion),Fecha_Cierre:P(C.Fecha_Cierre)})}s.sort((r,v)=>r.Estado===v.Estado?(v.Fecha_Creacion||"").localeCompare(r.Fecha_Creacion||""):r.Estado==="Abierto"?-1:1);const t=["id_proyecto","Codigo","Nombre_Proyecto","Decreto","Monitor","id_nudo","Estado","Clasificacion","Descripcion","Fecha_Creacion","Fecha_Cierre"],m=O.json_to_sheet(s,{header:t}),_=t.map(r=>({wch:Math.max(r.length,12)}));for(const r of s)t.forEach((v,C)=>{const ie=r[v]==null?"":String(r[v]);_[C].wch=Math.max(_[C].wch,ie.length)});m["!cols"]=_;const R=O.book_new();O.book_append_sheet(R,m,"NudosCriticos");const U=new Date,ne=`${U.getFullYear()}-${String(U.getMonth()+1).padStart(2,"0")}-${String(U.getDate()).padStart(2,"0")}`;me(R,`NudosCriticos_${ne}.xlsx`)}catch(a){console.error("Error al descargar Excel:",a),alert("No se pudo generar el Excel. Revisa la consola para más detalles.")}}const W=["Todos","Carolina Espinosa","Macarena Guerra","Claudia Pastenes","Katherinne Rodriguez","Alejandra Lobos","Javiera Diaz","Javiera Caceres","Joel Cáceres"],Q=["Todas","AGUAS ANDINAS","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOM","ENEL","ENEL COLINA","IMIV","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],X=["Todos","Abierto","Resuelto"],E=p(!1);function Z(){const a=new Date,e=String(a.getDate()).padStart(2,"0"),s=String(a.getMonth()+1).padStart(2,"0"),t=a.getFullYear();return`${e}-${s}-${t}`}const u=p({Estado:"",Clasificacion:"",Descripcion:"",id_nudo:"",Fecha_Creacion:Z()});async function ee(){if(n.value){u.value.id_nudo=n.value.Codigo+"/"+n.value.Nudo_Critico.length,n.value.Nudo_Critico.push({...u.value});try{const e=await fetch(`${V}/proyecto/${encodeURIComponent(n.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n.value)});if(!e.ok){const s=await e.text().catch(()=>"");throw new Error(`PATCH falló: ${e.status} ${e.statusText} ${s}`)}}catch(a){n.value.Nudo_Critico.pop(),E.value=!0,console.error("Error al agregar nudo crítico (BD):",a)}E.value=!1,console.log("Nuevo nudo crítico agregado:",u.value),u.value={Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:new Date().toISOString().split("T")[0]}}else console.log("Seleccione un proyecto antes de agregar un nudo crítico.")}const n=p(null),D=p(""),w=p("Todos"),S=p("Todas"),x=p("Todos"),i=p(null),oe=z(()=>{let a=A.value;if(D.value){const e=D.value.toLowerCase();a=a.filter(s=>s.Nombre_Proyecto.toLowerCase().includes(e)||s.Codigo.toString().includes(e))}return w.value!=="Todos"&&(a=a.filter(e=>e.Monitor===w.value)),a}),te=z(()=>{if(!n.value)return[];let a=n.value.Nudo_Critico;return S.value!=="Todas"&&(a=a.filter(e=>e.Clasificacion===S.value)),x.value!=="Todos"&&(a=a.filter(e=>e.Estado===x.value)),a.sort((e,s)=>e.Estado===s.Estado?new Date(s.Fecha_Creacion)-new Date(e.Fecha_Creacion):e.Estado==="Abierto"?-1:1),a});function ae(a){n.value=a,i.value=null}function le(a){i.value={...a}}async function se(){console.log("Cambios guardados");const a=n.value.Nudo_Critico.findIndex(e=>e.id_nudo===i.value.id_nudo);if(a===-1){console.error("No se encontró el nudo crítico en el proyecto.");return}n.value.Nudo_Critico[a]={...i.value},console.log("Nudo crítico actualizado en el proyecto");try{const e=await fetch(`${V}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n.value)});if(!e.ok)throw new Error(`Error al actualizar el proyecto: ${e.statusText}`);const s=await e.json();console.log("Proyecto actualizado con éxito"),alert("Cambios guardados correctamente")}catch(e){console.error("Error al guardar cambios:",e),alert("Hubo un error al guardar los cambios, contacte al administrador.")}}const A=p([]);async function re(){try{const a=await fetch(`${V}/proyecto/`);if(!a.ok)throw new Error(`Error al obtener proyectos: ${a.statusText}`);const e=await a.json();A.value=JSON.parse(JSON.stringify(e))}catch(a){console.error("Error al obtener los proyectos:",a)}}return Ee(()=>{console.log("API_BASE: ",V),re()}),(a,e)=>{const s=Ne("v-list-item-content");return f(),g(Ve,{class:"fill-height pa-0",fluid:"",style:{padding:"0","max-width":"100% !important","background-color":"#f5f5f5"}},{default:l(()=>[o(de,{color:"primary",dark:""},{default:l(()=>[o(ue,null,{default:l(()=>[...e[16]||(e[16]=[d("Sistema de Registro de Nudos Críticos",-1)])]),_:1}),o(ce),o(b,{color:"secondary",variant:"elevated",onClick:K},{default:l(()=>[o(pe,{left:""},{default:l(()=>[...e[17]||(e[17]=[d("mdi-download",-1)])]),_:1}),e[18]||(e[18]=d(" Descargar Excel ",-1))]),_:1})]),_:1}),o(ve,null,{default:l(()=>[o(B,{cols:"12",md:"4"},{default:l(()=>[o(h,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[20]||(e[20]=c("h2",{class:"text-h5 font-weight-bold"},"Proyectos",-1)),c("div",be,[o(M,{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=t=>D.value=t),label:"Buscar Proyecto",placeholder:"Nombre o Código",outlined:"",dense:""},null,8,["modelValue"])]),c("div",he,[o(y,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=t=>w.value=t),items:W,label:"Filtrar por Monitor",outlined:"",dense:""},null,8,["modelValue"])]),c("div",De,[o(Y,null,{default:l(()=>[(f(!0),k(I,null,q(oe.value,(t,m)=>(f(),k(I,{key:t.id},[o(F,{onClick:_=>ae(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(T,{class:"text-h6"},{default:l(()=>[d(N(t.Nombre_Proyecto),1)]),_:2},1024),o(L,null,{default:l(()=>[d("Código: "+N(t.Codigo),1)]),_:2},1024),o(L,null,{default:l(()=>[d("Monitor: "+N(t.Monitor),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),m<A.value.length-1?(f(),g(j,{key:0})):$("",!0)],64))),128)),A.value.length===0?(f(),g(F,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(T,{class:"text-h6"},{default:l(()=>[...e[19]||(e[19]=[d("No hay proyectos registrados.",-1)])]),_:1})]),_:1})]),_:1})):$("",!0)]),_:1})])]),_:1})]),_:1}),o(B,{cols:"12",md:"4"},{default:l(()=>[o(h,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[c("div",we,[e[22]||(e[22]=c("h2",{class:"text-h5 font-weight-bold"},"Nudos Críticos",-1)),o(b,{color:"primary",onClick:e[2]||(e[2]=t=>E.value=!0)},{default:l(()=>[...e[21]||(e[21]=[d("Nuevo Nudo",-1)])]),_:1})]),c("div",Se,[o(y,{modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=t=>x.value=t),items:X,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),c("div",xe,[o(y,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=t=>S.value=t),items:Q,label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"])]),c("p",Ae,"Proyecto: "+N(n.value?.Nombre_Proyecto||"Seleccione un proyecto"),1),c("div",Fe,[o(Y,null,{default:l(()=>[(f(!0),k(I,null,q(te.value,(t,m)=>(f(),k(I,{key:m},[o(F,{onClick:_=>le(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(T,{class:"text-h6"},{default:l(()=>[d("Estado: "+N(t.Estado),1)]),_:2},1024),o(L,null,{default:l(()=>[d("Clasificación: "+N(t.Clasificacion),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),m<n.value.Nudo_Critico.length-1?(f(),g(j,{key:0})):$("",!0)],64))),128)),!n.value||n.value.Nudo_Critico.length===0?(f(),g(F,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(T,{class:"text-h6"},{default:l(()=>[...e[23]||(e[23]=[d("No hay nudos críticos registrados.",-1)])]),_:1})]),_:1})]),_:1})):$("",!0)]),_:1})])]),_:1})]),_:1}),o(B,{cols:"12",md:"4"},{default:l(()=>[i.value?(f(),g(h,{key:0,class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[25]||(e[25]=c("h2",{class:"text-h5 font-weight-bold"},"Detalle del Nudo Crítico",-1)),o(J,{ref:"form"},{default:l(()=>[o(y,{modelValue:i.value.Estado,"onUpdate:modelValue":e[5]||(e[5]=t=>i.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(y,{modelValue:i.value.Clasificacion,"onUpdate:modelValue":e[6]||(e[6]=t=>i.value.Clasificacion=t),items:["ENEL","Aguas Andinas","SEREMI"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(G,{modelValue:i.value.Descripcion,"onUpdate:modelValue":e[7]||(e[7]=t=>i.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(M,{modelValue:i.value.Fecha_Creacion,"onUpdate:modelValue":e[8]||(e[8]=t=>i.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"]),o(M,{modelValue:i.value.Fecha_Cierre,"onUpdate:modelValue":e[9]||(e[9]=t=>i.value.Fecha_Cierre=t),label:"Fecha de Cierre",outlined:"",dense:""},null,8,["modelValue"]),o(b,{color:"primary",class:"mt-4",onClick:se},{default:l(()=>[...e[24]||(e[24]=[d("Guardar Cambios",-1)])]),_:1})]),_:1},512)]),_:1})):(f(),g(h,{key:1,class:"pa-4",style:{height:"100%"}},{default:l(()=>[...e[26]||(e[26]=[c("h2",{class:"text-h5 font-weight-bold"},"Seleccione un Nudo Crítico",-1)])]),_:1}))]),_:1})]),_:1}),o(fe,{modelValue:E.value,"onUpdate:modelValue":e[15]||(e[15]=t=>E.value=t),persistent:"","max-width":"500px"},{default:l(()=>[o(h,null,{default:l(()=>[o(ge,{class:"text-h5"},{default:l(()=>[...e[27]||(e[27]=[d("Agregar Nuevo Nudo Crítico",-1)])]),_:1}),o(_e,null,{default:l(()=>[o(J,{ref:"formNuevoNudo"},{default:l(()=>[o(y,{modelValue:u.value.Estado,"onUpdate:modelValue":e[10]||(e[10]=t=>u.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(y,{modelValue:u.value.Clasificacion,"onUpdate:modelValue":e[11]||(e[11]=t=>u.value.Clasificacion=t),items:["AGUAS ANDINAS","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOM","ENEL","ENEL COLINA","IMIV","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(G,{modelValue:u.value.Descripcion,"onUpdate:modelValue":e[12]||(e[12]=t=>u.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(M,{modelValue:u.value.Fecha_Creacion,"onUpdate:modelValue":e[13]||(e[13]=t=>u.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(ye,null,{default:l(()=>[o(b,{color:"primary",onClick:ee},{default:l(()=>[...e[28]||(e[28]=[d("Guardar",-1)])]),_:1}),o(b,{text:"",onClick:e[14]||(e[14]=t=>E.value=!1)},{default:l(()=>[...e[29]||(e[29]=[d("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},Me=Ce(Te,[["__scopeId","data-v-37e2bdea"]]),Pe={__name:"index",setup(H){return(V,P)=>(f(),g(Me))}};export{Pe as default};
