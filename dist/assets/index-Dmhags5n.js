import{r as p,g as z,h as ge,i as Ve,c as E,o as c,w as l,b as o,f as i,d as f,j as k,k as F,F as M,l as J,t as _,e as be}from"./index-CslxvJBt.js";import{V as Ee,a as Ne,b as _e,c as V,d as H,e as U,f as I,g as L,h as q,i as K,j as W,u as B,w as we}from"./VTextarea-wOI4HOsz.js";import{_ as xe,e as b,g as Q,V as X,a as h,b as w,d as x,c as j,h as Z,i as ee,j as oe,f as De}from"./VTextField-B01PdJfj.js";const he={class:"mb-4"},Ae={class:"mb-4"},Se={class:"lista-scroll"},Te={class:"mb-4"},Pe={class:"mb-4"},$e={class:"text-subtitle-1"},ke={class:"lista-scroll"},Fe={__name:"Administrador",setup(te){const v="https://backend-nudos-criticos-eadacb96aa89.herokuapp.com",O=["Todos","Carolina Espinosa","Macarena Guerra","Claudia Pastenes","Katherinne Rodriguez","Alejandra Lobos","Javiera Diaz","Javiera Caceres","Joel Cáceres"],ae=["Todas","AGUAS ANDINAS","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOM","ENEL","ENEL COLINA","IMIV","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],le=["Todos","Abierto","Resuelto"],r=p(null),A=p(""),S=p("Todos"),T=p("Todas"),P=p("Todos"),d=p(null);function Y(a){if(!a)return"";if(/^\d{2}-\d{2}-\d{4}$/.test(a)){const[t,m,y]=a.split("-");return`${y}-${m}-${t}`}const s=new Date(a.replaceAll("/","-"));return isNaN(s.getTime())?a:s.toISOString().slice(0,10)}async function re(){try{const a=await fetch(`${v}/proyecto/`);if(!a.ok)throw new Error(`Error obteniendo BD: ${a.status} ${a.statusText}`);const e=await a.json(),s=[];for(const n of e){const g=Array.isArray(n.Nudo_Critico)?n.Nudo_Critico:[];if(g.length===0)s.push({id_proyecto:n.id??"",Codigo:n.Codigo??"",Nombre_Proyecto:n.Nombre_Proyecto??"",Decreto:n.Decreto??"",Monitor:n.Monitor??"",id_nudo:"",Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:"",Fecha_Cierre:""});else for(const C of g)s.push({id_proyecto:n.id??"",Codigo:n.Codigo??"",Nombre_Proyecto:n.Nombre_Proyecto??"",Decreto:n.Decreto??"",Monitor:n.Monitor??"",id_nudo:C.id_nudo??"",Estado:C.Estado??"",Clasificacion:C.Clasificacion??"",Descripcion:C.Descripcion??"",Fecha_Creacion:Y(C.Fecha_Creacion),Fecha_Cierre:Y(C.Fecha_Cierre)})}s.sort((n,g)=>n.Estado===g.Estado?(g.Fecha_Creacion||"").localeCompare(n.Fecha_Creacion||""):n.Estado==="Abierto"?-1:1);const t=["id_proyecto","Codigo","Nombre_Proyecto","Decreto","Monitor","id_nudo","Estado","Clasificacion","Descripcion","Fecha_Creacion","Fecha_Cierre"],m=B.json_to_sheet(s,{header:t}),y=t.map(n=>({wch:Math.max(n.length,12)}));for(const n of s)t.forEach((g,C)=>{const ye=n[g]==null?"":String(n[g]);y[C].wch=Math.max(y[C].wch,ye.length)});m["!cols"]=y;const G=B.book_new();B.book_append_sheet(G,m,"NudosCriticos");const R=new Date,ve=`${R.getFullYear()}-${String(R.getMonth()+1).padStart(2,"0")}-${String(R.getDate()).padStart(2,"0")}`;we(G,`NudosCriticos_${ve}.xlsx`)}catch(a){console.error("Error al descargar Excel:",a),alert("No se pudo generar el Excel. Revisa la consola para más detalles.")}}const D=p(!1),N=p(!1);function se(){const a=new Date,e=String(a.getDate()).padStart(2,"0"),s=String(a.getMonth()+1).padStart(2,"0"),t=a.getFullYear();return`${e}-${s}-${t}`}const u=p({Estado:"",Clasificacion:"",Descripcion:"",id_nudo:"",Fecha_Creacion:se()});async function ne(){if(r.value){u.value.id_nudo=r.value.Codigo+"/"+r.value.Nudo_Critico.length,r.value.Nudo_Critico.push({...u.value});try{const e=await fetch(`${v}/proyecto/${encodeURIComponent(r.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!e.ok){const s=await e.text().catch(()=>"");throw new Error(`PATCH falló: ${e.status} ${e.statusText} ${s}`)}}catch(a){r.value.Nudo_Critico.pop(),N.value=!0,console.error("Error al agregar nudo crítico (BD):",a)}N.value=!1,console.log("Nuevo nudo crítico agregado:",u.value),u.value={Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:new Date().toISOString().split("T")[0]}}else console.log("Seleccione un proyecto antes de agregar un nudo crítico.")}const ie=z(()=>{let a=$.value;if(A.value){const e=A.value.toLowerCase();a=a.filter(s=>s.Nombre_Proyecto.toLowerCase().includes(e)||s.Codigo.toString().includes(e))}return S.value!=="Todos"&&(a=a.filter(e=>e.Monitor===S.value)),a}),de=z(()=>{if(!r.value)return[];let a=r.value.Nudo_Critico;return T.value!=="Todas"&&(a=a.filter(e=>e.Clasificacion===T.value)),P.value!=="Todos"&&(a=a.filter(e=>e.Estado===P.value)),a.sort((e,s)=>e.Estado===s.Estado?new Date(s.Fecha_Creacion)-new Date(e.Fecha_Creacion):e.Estado==="Abierto"?-1:1),a});function ue(a){r.value=a,d.value=null}function ce(a){d.value={...a}}async function me(){console.log("Cambios guardados");const a=r.value.Nudo_Critico.findIndex(e=>e.id_nudo===d.value.id_nudo);if(a===-1){console.error("No se encontró el nudo crítico en el proyecto.");return}r.value.Nudo_Critico[a]={...d.value},console.log("Nudo crítico actualizado en el proyecto");try{const e=await fetch(`${v}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!e.ok)throw new Error(`Error al actualizar el proyecto: ${e.statusText}`);const s=await e.json();console.log("Proyecto actualizado con éxito"),alert("Cambios guardados correctamente")}catch(e){console.error("Error al guardar cambios:",e),alert("Hubo un error al guardar los cambios, contacte al administrador.")}}async function fe(){console.log("Proyecto editado:",r.value);try{const a=await fetch(`${v}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!a.ok)throw new Error(`Error al actualizar el proyecto: ${a.statusText}`);const e=await a.json();console.log("Proyecto actualizado con éxito"),alert("Proyecto actualizado correctamente"),D.value=!1}catch(a){console.error("Error al guardar cambios del proyecto:",a),alert("Hubo un error al guardar los cambios del proyecto, contacte al administrador.")}}const $=p([]);async function pe(){try{const a=await fetch(`${v}/proyecto/`);if(!a.ok)throw new Error(`Error al obtener proyectos: ${a.statusText}`);const e=await a.json();$.value=JSON.parse(JSON.stringify(e))}catch(a){console.error("Error al obtener los proyectos:",a)}}ge(()=>{console.log("API_BASE: ",v),pe()});async function Ce(a){if(!r.value)return;const e=r.value.Nudo_Critico.findIndex(s=>s.id_nudo===a.id_nudo);if(e!==-1){r.value.Nudo_Critico.splice(e,1);try{const t=await fetch(`${v}/proyecto/${encodeURIComponent(r.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!t.ok){const m=await t.text().catch(()=>"");throw new Error(`PATCH falló: ${t.status} ${t.statusText} ${m}`)}d.value&&d.value.id_nudo===a.id_nudo&&(d.value=null)}catch(s){console.error("Error al eliminar nudo crítico (BD):",s),alert("No se pudo eliminar el nudo crítico. Revisa la consola para más detalles.")}}}return(a,e)=>{const s=Ve("v-list-item-content");return c(),E(De,{class:"fill-height pa-0",fluid:"",style:{padding:"0","max-width":"100% !important","background-color":"#f5f5f5"}},{default:l(()=>[o(Ee,{color:"primary",dark:""},{default:l(()=>[o(Ne,null,{default:l(()=>[...e[22]||(e[22]=[i("Sistema de Registro de Nudos Críticos - Administrador",-1)])]),_:1}),o(_e),o(b,{color:"secondary",variant:"elevated",onClick:re},{default:l(()=>[o(Q,{left:""},{default:l(()=>[...e[23]||(e[23]=[i("mdi-download",-1)])]),_:1}),e[24]||(e[24]=i(" Descargar Excel ",-1))]),_:1})]),_:1}),o(X,null,{default:l(()=>[o(h,{cols:"12",md:"4"},{default:l(()=>[o(w,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[26]||(e[26]=f("h2",{class:"text-h5 font-weight-bold"},"Proyectos",-1)),f("div",he,[o(x,{modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=t=>A.value=t),label:"Buscar Proyecto",placeholder:"Nombre o Código",outlined:"",dense:""},null,8,["modelValue"])]),f("div",Ae,[o(V,{modelValue:S.value,"onUpdate:modelValue":e[1]||(e[1]=t=>S.value=t),items:O,label:"Filtrar por Monitor",outlined:"",dense:""},null,8,["modelValue"])]),f("div",Se,[o(H,null,{default:l(()=>[(c(!0),k(M,null,J(ie.value,(t,m)=>(c(),k(M,{key:t.id},[o(U,{onClick:y=>ue(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(I,{class:"text-h6"},{default:l(()=>[i(_(t.Nombre_Proyecto),1)]),_:2},1024),o(L,null,{default:l(()=>[i("Código: "+_(t.Codigo),1)]),_:2},1024),o(L,null,{default:l(()=>[i("Monitor: "+_(t.Monitor),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),m<$.value.length-1?(c(),E(q,{key:0})):F("",!0)],64))),128)),$.value.length===0?(c(),E(U,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(I,{class:"text-h6"},{default:l(()=>[...e[25]||(e[25]=[i("No hay proyectos registrados.",-1)])]),_:1})]),_:1})]),_:1})):F("",!0)]),_:1})])]),_:1})]),_:1}),o(h,{cols:"12",md:"4"},{default:l(()=>[o(w,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[o(X,{class:"align-center justify-space-between"},{default:l(()=>[o(h,{cols:"12",md:"4",class:"d-flex align-center"},{default:l(()=>[...e[27]||(e[27]=[f("h2",{class:"text-h5 font-weight-bold mb-0"},"Nudos Críticos",-1)])]),_:1}),o(h,{cols:"12",md:"8",class:"d-flex justify-end flex-wrap"},{default:l(()=>[o(b,{color:"primary",class:"mb-2 mr-2",onClick:e[2]||(e[2]=t=>N.value=!0)},{default:l(()=>[...e[28]||(e[28]=[i(" NUEVO NUDO ",-1)])]),_:1}),o(b,{color:"primary",class:"mb-2",onClick:e[3]||(e[3]=t=>D.value=!0)},{default:l(()=>[...e[29]||(e[29]=[i(" EDITAR PROYECTO ",-1)])]),_:1})]),_:1})]),_:1}),f("div",Te,[o(V,{modelValue:P.value,"onUpdate:modelValue":e[4]||(e[4]=t=>P.value=t),items:le,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),f("div",Pe,[o(V,{modelValue:T.value,"onUpdate:modelValue":e[5]||(e[5]=t=>T.value=t),items:ae,label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"])]),f("p",$e,"Proyecto: "+_(r.value?.Nombre_Proyecto||"Seleccione un proyecto"),1),f("div",ke,[o(H,null,{default:l(()=>[(c(!0),k(M,null,J(de.value,(t,m)=>(c(),k(M,{key:m},[o(U,{onClick:y=>ce(t),class:"cursor-pointer"},{append:l(()=>[o(Q,{size:"22",color:"grey-darken-1",class:"mr-2 cursor-pointer",onClick:be(y=>Ce(t),["stop"])},{default:l(()=>[...e[30]||(e[30]=[i(" mdi-delete ",-1)])]),_:1},8,["onClick"])]),default:l(()=>[o(s,null,{default:l(()=>[o(I,{class:"text-h6"},{default:l(()=>[i("Estado: "+_(t.Estado),1)]),_:2},1024),o(L,null,{default:l(()=>[i("Clasificación: "+_(t.Clasificacion),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),m<r.value.Nudo_Critico.length-1?(c(),E(q,{key:0})):F("",!0)],64))),128)),!r.value||r.value.Nudo_Critico.length===0?(c(),E(U,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(I,{class:"text-h6"},{default:l(()=>[...e[31]||(e[31]=[i("No hay nudos críticos registrados.",-1)])]),_:1})]),_:1})]),_:1})):F("",!0)]),_:1})])]),_:1})]),_:1}),o(h,{cols:"12",md:"4"},{default:l(()=>[d.value?(c(),E(w,{key:0,class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[33]||(e[33]=f("h2",{class:"text-h5 font-weight-bold"},"Detalle del Nudo Crítico",-1)),o(j,{ref:"form"},{default:l(()=>[o(V,{modelValue:d.value.Estado,"onUpdate:modelValue":e[6]||(e[6]=t=>d.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(V,{modelValue:d.value.Clasificacion,"onUpdate:modelValue":e[7]||(e[7]=t=>d.value.Clasificacion=t),items:["ENEL","Aguas Andinas","SEREMI"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(K,{modelValue:d.value.Descripcion,"onUpdate:modelValue":e[8]||(e[8]=t=>d.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(x,{modelValue:d.value.Fecha_Creacion,"onUpdate:modelValue":e[9]||(e[9]=t=>d.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"]),o(x,{modelValue:d.value.Fecha_Cierre,"onUpdate:modelValue":e[10]||(e[10]=t=>d.value.Fecha_Cierre=t),label:"Fecha de Cierre",outlined:"",dense:""},null,8,["modelValue"]),o(b,{color:"primary",class:"mt-4",onClick:me},{default:l(()=>[...e[32]||(e[32]=[i("Guardar Cambios",-1)])]),_:1})]),_:1},512)]),_:1})):(c(),E(w,{key:1,class:"pa-4",style:{height:"100%"}},{default:l(()=>[...e[34]||(e[34]=[f("h2",{class:"text-h5 font-weight-bold"},"Seleccione un Nudo Crítico",-1)])]),_:1}))]),_:1})]),_:1}),o(W,{modelValue:N.value,"onUpdate:modelValue":e[16]||(e[16]=t=>N.value=t),persistent:"","max-width":"500px"},{default:l(()=>[o(w,null,{default:l(()=>[o(Z,{class:"text-h5"},{default:l(()=>[...e[35]||(e[35]=[i("Agregar Nuevo Nudo Crítico",-1)])]),_:1}),o(ee,null,{default:l(()=>[o(j,{ref:"formNuevoNudo"},{default:l(()=>[o(V,{modelValue:u.value.Estado,"onUpdate:modelValue":e[11]||(e[11]=t=>u.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(V,{modelValue:u.value.Clasificacion,"onUpdate:modelValue":e[12]||(e[12]=t=>u.value.Clasificacion=t),items:["AGUAS ANDINAS","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOM","ENEL","ENEL COLINA","IMIV","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(K,{modelValue:u.value.Descripcion,"onUpdate:modelValue":e[13]||(e[13]=t=>u.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(x,{modelValue:u.value.Fecha_Creacion,"onUpdate:modelValue":e[14]||(e[14]=t=>u.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(oe,null,{default:l(()=>[o(b,{color:"primary",onClick:ne},{default:l(()=>[...e[36]||(e[36]=[i("Guardar",-1)])]),_:1}),o(b,{text:"",onClick:e[15]||(e[15]=t=>N.value=!1)},{default:l(()=>[...e[37]||(e[37]=[i("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(W,{modelValue:D.value,"onUpdate:modelValue":e[21]||(e[21]=t=>D.value=t),persistent:"","max-width":"500px"},{default:l(()=>[o(w,null,{default:l(()=>[o(Z,{class:"text-h5"},{default:l(()=>[...e[38]||(e[38]=[i("Editar un Proyecto",-1)])]),_:1}),o(ee,null,{default:l(()=>[o(j,{ref:"formNuevoNudo"},{default:l(()=>[o(x,{modelValue:r.value.Nombre_Proyecto,"onUpdate:modelValue":e[17]||(e[17]=t=>r.value.Nombre_Proyecto=t),label:"Nombre Proyecto",outlined:"",dense:""},null,8,["modelValue"]),o(x,{modelValue:r.value.Codigo,"onUpdate:modelValue":e[18]||(e[18]=t=>r.value.Codigo=t),label:"Codigo de Proyecto",outlined:"",dense:""},null,8,["modelValue"]),o(V,{modelValue:r.value.Monitor,"onUpdate:modelValue":e[19]||(e[19]=t=>r.value.Monitor=t),items:O,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(oe,null,{default:l(()=>[o(b,{color:"primary",onClick:fe},{default:l(()=>[...e[39]||(e[39]=[i("Guardar",-1)])]),_:1}),o(b,{text:"",onClick:e[20]||(e[20]=t=>D.value=!1)},{default:l(()=>[...e[40]||(e[40]=[i("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},Me=xe(Fe,[["__scopeId","data-v-c3c87670"]]),Re={__name:"index",setup(te){return(v,O)=>(c(),E(Me))}};export{Re as default};
