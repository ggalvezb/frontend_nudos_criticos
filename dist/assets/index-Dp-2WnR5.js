import{r as c,g as X,h as ge,i as be,c as N,o as m,w as a,b as o,f as s,d as C,j as U,k as L,F as k,l as Z,t as D,e as De}from"./index-ClB84Hoa.js";import{V as Se,a as Ie,b as _e,c as y,d as ee,e as $,f as F,g as G,h as oe,i as j,j as Y,u as z,w as Me}from"./VTextarea-Vp5RFEAQ.js";import{_ as Te,e as p,g as le,V as ae,a as T,b as g,d as S,c as H,h as J,i as q,j as K,f as Oe}from"./VTextField-BRAEGQPQ.js";const Pe={class:"mb-4"},xe={class:"mb-4"},we={class:"lista-scroll"},Re={class:"mb-4"},Ue={class:"mb-4"},Le={class:"text-subtitle-1"},ke={class:"lista-scroll"},$e={__name:"Administrador",setup(te){const E="https://backend-nudos-criticos-eadacb96aa89.herokuapp.com",h=["Todos","Carolina Espinosa","Macarena Guerra","Claudia Pastenes","Katherinne Rodriguez","Alejandra Lobos","Javiera Diaz","Javiera Caceres","Joel Cáceres"],re=["Todas","ALCANTARILLADO","AGUAS ANDINAS","ALUMBRADO PÚBLICO","APR","BOMBEROS","CGE","CNM","CONSTRUCTORA","DGA","DGAC","DIA","DIMAO","DIMAS","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MINVU","MOP","OBRA","PAVEL","SACYR","SEC","SEREMITT","SEREMI SALUD","SEREMI VIVIENDA","SERVIU","SMAPA","TRANSITO MUNICIPAL","TEP","UOCT"],ne=["Todos","Abierto","Resuelto"],r=c(null),O=c(""),P=c("Todos"),x=c("Todas"),w=c("Todos"),d=c(null),I=c(!1),_=c(null);function W(t){if(!t)return"";if(/^\d{2}-\d{2}-\d{4}$/.test(t)){const[l,f,A]=t.split("-");return`${A}-${f}-${l}`}const n=new Date(t.replaceAll("/","-"));return isNaN(n.getTime())?t:n.toISOString().slice(0,10)}async function se(){try{const t=await fetch(`${E}/proyecto/`);if(!t.ok)throw new Error(`Error obteniendo BD: ${t.status} ${t.statusText}`);const e=await t.json(),n=[];for(const i of e){const V=Array.isArray(i.Nudo_Critico)?i.Nudo_Critico:[];if(V.length===0)n.push({id_proyecto:i.id??"",Codigo:i.Codigo??"",Nombre_Proyecto:i.Nombre_Proyecto??"",Decreto:i.Decreto??"",Monitor:i.Monitor??"",id_nudo:"",Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:"",Fecha_Cierre:""});else for(const v of V)n.push({id_proyecto:i.id??"",Codigo:i.Codigo??"",Nombre_Proyecto:i.Nombre_Proyecto??"",Decreto:i.Decreto??"",Monitor:i.Monitor??"",id_nudo:v.id_nudo??"",Estado:v.Estado??"",Clasificacion:v.Clasificacion??"",Descripcion:v.Descripcion??"",Fecha_Creacion:W(v.Fecha_Creacion),Fecha_Cierre:W(v.Fecha_Cierre)})}n.sort((i,V)=>i.Estado===V.Estado?(V.Fecha_Creacion||"").localeCompare(i.Fecha_Creacion||""):i.Estado==="Abierto"?-1:1);const l=["id_proyecto","Codigo","Nombre_Proyecto","Decreto","Monitor","id_nudo","Estado","Clasificacion","Descripcion","Fecha_Creacion","Fecha_Cierre"],f=z.json_to_sheet(n,{header:l}),A=l.map(i=>({wch:Math.max(i.length,12)}));for(const i of n)l.forEach((V,v)=>{const Ne=i[V]==null?"":String(i[V]);A[v].wch=Math.max(A[v].wch,Ne.length)});f["!cols"]=A;const Q=z.book_new();z.book_append_sheet(Q,f,"NudosCriticos");const B=new Date,ye=`${B.getFullYear()}-${String(B.getMonth()+1).padStart(2,"0")}-${String(B.getDate()).padStart(2,"0")}`;Me(Q,`NudosCriticos_${ye}.xlsx`)}catch(t){console.error("Error al descargar Excel:",t),alert("No se pudo generar el Excel. Revisa la consola para más detalles.")}}const M=c(!1),b=c(!1);function ie(){const t=new Date,e=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),l=t.getFullYear();return`${e}-${n}-${l}`}const u=c({Estado:"",Clasificacion:"",Descripcion:"",id_nudo:"",Fecha_Creacion:ie()});async function de(){if(r.value){u.value.id_nudo=r.value.Codigo+"/"+r.value.Nudo_Critico.length,r.value.Nudo_Critico.push({...u.value});try{const e=await fetch(`${E}/proyecto/${encodeURIComponent(r.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!e.ok){const n=await e.text().catch(()=>"");throw new Error(`PATCH falló: ${e.status} ${e.statusText} ${n}`)}}catch(t){r.value.Nudo_Critico.pop(),b.value=!0,console.error("Error al agregar nudo crítico (BD):",t)}b.value=!1,console.log("Nuevo nudo crítico agregado:",u.value),u.value={Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:new Date().toISOString().split("T")[0]}}else console.log("Seleccione un proyecto antes de agregar un nudo crítico.")}const ue=X(()=>{let t=R.value;if(O.value){const e=O.value.toLowerCase();t=t.filter(n=>n.Nombre_Proyecto.toLowerCase().includes(e)||n.Codigo.toString().includes(e))}return P.value!=="Todos"&&(t=t.filter(e=>e.Monitor===P.value)),t}),ce=X(()=>{if(!r.value)return[];let t=r.value.Nudo_Critico;return x.value!=="Todas"&&(t=t.filter(e=>e.Clasificacion===x.value)),w.value!=="Todos"&&(t=t.filter(e=>e.Estado===w.value)),t.sort((e,n)=>e.Estado===n.Estado?new Date(n.Fecha_Creacion)-new Date(e.Fecha_Creacion):e.Estado==="Abierto"?-1:1),t});function me(t){r.value=t,d.value=null}function fe(t){d.value={...t}}async function Ce(){console.log("Cambios guardados");const t=r.value.Nudo_Critico.findIndex(e=>e.id_nudo===d.value.id_nudo);if(t===-1){console.error("No se encontró el nudo crítico en el proyecto.");return}r.value.Nudo_Critico[t]={...d.value},console.log("Nudo crítico actualizado en el proyecto");try{const e=await fetch(`${E}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!e.ok)throw new Error(`Error al actualizar el proyecto: ${e.statusText}`);const n=await e.json();console.log("Proyecto actualizado con éxito"),alert("Cambios guardados correctamente")}catch(e){console.error("Error al guardar cambios:",e),alert("Hubo un error al guardar los cambios, contacte al administrador.")}}async function pe(){console.log("Proyecto editado:",r.value);try{const t=await fetch(`${E}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!t.ok)throw new Error(`Error al actualizar el proyecto: ${t.statusText}`);const e=await t.json();console.log("Proyecto actualizado con éxito"),alert("Proyecto actualizado correctamente"),M.value=!1}catch(t){console.error("Error al guardar cambios del proyecto:",t),alert("Hubo un error al guardar los cambios del proyecto, contacte al administrador.")}}const R=c([]);async function ve(){try{const t=await fetch(`${E}/proyecto/`);if(!t.ok)throw new Error(`Error al obtener proyectos: ${t.statusText}`);const e=await t.json();R.value=JSON.parse(JSON.stringify(e))}catch(t){console.error("Error al obtener los proyectos:",t)}}ge(()=>{console.log("API_BASE: ",E),ve()});async function Ee(t){if(!r.value)return;const e=r.value.Nudo_Critico.findIndex(n=>n.id_nudo===t.id_nudo);if(e!==-1){r.value.Nudo_Critico.splice(e,1);try{const l=await fetch(`${E}/proyecto/${encodeURIComponent(r.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!l.ok){const f=await l.text().catch(()=>"");throw new Error(`PATCH falló: ${l.status} ${l.statusText} ${f}`)}d.value&&d.value.id_nudo===t.id_nudo&&(d.value=null)}catch(n){console.error("Error al eliminar nudo crítico (BD):",n),alert("No se pudo eliminar el nudo crítico. Revisa la consola para más detalles.")}}}function Ae(t){_.value=t,I.value=!0}async function Ve(){_.value&&(console.log("Se elimina proyecto:",_.value),await Ee(_.value),I.value=!1,_.value=null)}return(t,e)=>{const n=be("v-list-item-content");return m(),N(Oe,{class:"fill-height pa-0",fluid:"",style:{padding:"0","max-width":"100% !important","background-color":"#f5f5f5"}},{default:a(()=>[o(Se,{color:"primary",dark:""},{default:a(()=>[o(Ie,null,{default:a(()=>[...e[25]||(e[25]=[s("Sistema de Registro de Nudos Críticos - Administrador",-1)])]),_:1}),o(_e),o(p,{color:"secondary",variant:"elevated",onClick:se},{default:a(()=>[o(le,{left:""},{default:a(()=>[...e[26]||(e[26]=[s("mdi-download",-1)])]),_:1}),e[27]||(e[27]=s(" Descargar Excel ",-1))]),_:1})]),_:1}),o(ae,null,{default:a(()=>[o(T,{cols:"12",md:"4"},{default:a(()=>[o(g,{class:"pa-4",style:{height:"100%"}},{default:a(()=>[e[29]||(e[29]=C("h2",{class:"text-h5 font-weight-bold"},"Proyectos",-1)),C("div",Pe,[o(S,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=l=>O.value=l),label:"Buscar Proyecto",placeholder:"Nombre o Código",outlined:"",dense:""},null,8,["modelValue"])]),C("div",xe,[o(y,{modelValue:P.value,"onUpdate:modelValue":e[1]||(e[1]=l=>P.value=l),items:h,label:"Filtrar por Monitor",outlined:"",dense:""},null,8,["modelValue"])]),C("div",we,[o(ee,null,{default:a(()=>[(m(!0),U(k,null,Z(ue.value,(l,f)=>(m(),U(k,{key:l.id},[o($,{onClick:A=>me(l),class:"cursor-pointer"},{default:a(()=>[o(n,null,{default:a(()=>[o(F,{class:"text-h6"},{default:a(()=>[s(D(l.Nombre_Proyecto),1)]),_:2},1024),o(G,null,{default:a(()=>[s("Código: "+D(l.Codigo),1)]),_:2},1024),o(G,null,{default:a(()=>[s("Monitor: "+D(l.Monitor),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),f<R.value.length-1?(m(),N(oe,{key:0})):L("",!0)],64))),128)),R.value.length===0?(m(),N($,{key:0},{default:a(()=>[o(n,null,{default:a(()=>[o(F,{class:"text-h6"},{default:a(()=>[...e[28]||(e[28]=[s("No hay proyectos registrados.",-1)])]),_:1})]),_:1})]),_:1})):L("",!0)]),_:1})])]),_:1})]),_:1}),o(T,{cols:"12",md:"4"},{default:a(()=>[o(g,{class:"pa-4",style:{height:"100%"}},{default:a(()=>[o(ae,{class:"align-center justify-space-between"},{default:a(()=>[o(T,{cols:"12",md:"4",class:"d-flex align-center"},{default:a(()=>[...e[30]||(e[30]=[C("h2",{class:"text-h5 font-weight-bold mb-0"},"Nudos Críticos",-1)])]),_:1}),o(T,{cols:"12",md:"8",class:"d-flex justify-end flex-wrap"},{default:a(()=>[o(p,{color:"primary",class:"mb-2 mr-2",onClick:e[2]||(e[2]=l=>b.value=!0)},{default:a(()=>[...e[31]||(e[31]=[s(" NUEVO NUDO ",-1)])]),_:1}),o(p,{color:"primary",class:"mb-2",onClick:e[3]||(e[3]=l=>M.value=!0)},{default:a(()=>[...e[32]||(e[32]=[s(" EDITAR PROYECTO ",-1)])]),_:1})]),_:1})]),_:1}),C("div",Re,[o(y,{modelValue:w.value,"onUpdate:modelValue":e[4]||(e[4]=l=>w.value=l),items:ne,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),C("div",Ue,[o(y,{modelValue:x.value,"onUpdate:modelValue":e[5]||(e[5]=l=>x.value=l),items:re,label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"])]),C("p",Le,"Proyecto: "+D(r.value?.Nombre_Proyecto||"Seleccione un proyecto"),1),C("div",ke,[o(ee,null,{default:a(()=>[(m(!0),U(k,null,Z(ce.value,(l,f)=>(m(),U(k,{key:f},[o($,{onClick:A=>fe(l),class:"cursor-pointer"},{append:a(()=>[o(le,{size:"22",color:"grey-darken-1",class:"mr-2 cursor-pointer",onClick:De(A=>Ae(l),["stop"])},{default:a(()=>[...e[33]||(e[33]=[s(" mdi-delete ",-1)])]),_:1},8,["onClick"])]),default:a(()=>[o(n,null,{default:a(()=>[o(F,{class:"text-h6"},{default:a(()=>[s("Estado: "+D(l.Estado),1)]),_:2},1024),o(G,null,{default:a(()=>[s("Clasificación: "+D(l.Clasificacion),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),f<r.value.Nudo_Critico.length-1?(m(),N(oe,{key:0})):L("",!0)],64))),128)),!r.value||r.value.Nudo_Critico.length===0?(m(),N($,{key:0},{default:a(()=>[o(n,null,{default:a(()=>[o(F,{class:"text-h6"},{default:a(()=>[...e[34]||(e[34]=[s("No hay nudos críticos registrados.",-1)])]),_:1})]),_:1})]),_:1})):L("",!0)]),_:1})])]),_:1})]),_:1}),o(T,{cols:"12",md:"4"},{default:a(()=>[d.value?(m(),N(g,{key:0,class:"pa-4",style:{height:"100%"}},{default:a(()=>[e[36]||(e[36]=C("h2",{class:"text-h5 font-weight-bold"},"Detalle del Nudo Crítico",-1)),o(H,{ref:"form"},{default:a(()=>[o(y,{modelValue:d.value.Estado,"onUpdate:modelValue":e[6]||(e[6]=l=>d.value.Estado=l),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(y,{modelValue:d.value.Clasificacion,"onUpdate:modelValue":e[7]||(e[7]=l=>d.value.Clasificacion=l),items:["ALCANTARILLADO","AGUAS ANDINAS","ALUMBRADO PÚBLICO","APR","BOMBEROS","CGE","CNM","CONSTRUCTORA","DGA","DGAC","DIA","DIMAO","DIMAS","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MINVU","MOP","OBRA","PAVEL","SACYR","SEC","SEREMITT","SEREMI SALUD","SEREMI VIVIENDA","SERVIU","SMAPA","TRANSITO MUNICIPAL","TEP","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(j,{modelValue:d.value.Descripcion,"onUpdate:modelValue":e[8]||(e[8]=l=>d.value.Descripcion=l),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(j,{modelValue:d.value.Informacion_Adicional,"onUpdate:modelValue":e[9]||(e[9]=l=>d.value.Informacion_Adicional=l),label:"Información Adicional",outlined:"",dense:""},null,8,["modelValue"]),o(S,{modelValue:d.value.Fecha_Creacion,"onUpdate:modelValue":e[10]||(e[10]=l=>d.value.Fecha_Creacion=l),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"]),o(S,{modelValue:d.value.Fecha_Cierre,"onUpdate:modelValue":e[11]||(e[11]=l=>d.value.Fecha_Cierre=l),label:"Fecha de Cierre",outlined:"",dense:""},null,8,["modelValue"]),o(p,{color:"primary",class:"mt-4",onClick:Ce},{default:a(()=>[...e[35]||(e[35]=[s("Guardar Cambios",-1)])]),_:1})]),_:1},512)]),_:1})):(m(),N(g,{key:1,class:"pa-4",style:{height:"100%"}},{default:a(()=>[...e[37]||(e[37]=[C("h2",{class:"text-h5 font-weight-bold"},"Seleccione un Nudo Crítico",-1)])]),_:1}))]),_:1})]),_:1}),o(Y,{modelValue:b.value,"onUpdate:modelValue":e[17]||(e[17]=l=>b.value=l),persistent:"","max-width":"500px"},{default:a(()=>[o(g,null,{default:a(()=>[o(J,{class:"text-h5"},{default:a(()=>[...e[38]||(e[38]=[s("Agregar Nuevo Nudo Crítico",-1)])]),_:1}),o(q,null,{default:a(()=>[o(H,{ref:"formNuevoNudo"},{default:a(()=>[o(y,{modelValue:u.value.Estado,"onUpdate:modelValue":e[12]||(e[12]=l=>u.value.Estado=l),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(y,{modelValue:u.value.Clasificacion,"onUpdate:modelValue":e[13]||(e[13]=l=>u.value.Clasificacion=l),items:["ALCANTARILLADO","AGUAS ANDINAS","ALUMBRADO PÚBLICO","APR","BOMBEROS","CGE","CNM","CONSTRUCTORA","DGA","DGAC","DIA","DIMAO","DIMAS","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MINVU","MOP","OBRA","PAVEL","SACYR","SEC","SEREMITT","SEREMI SALUD","SEREMI VIVIENDA","SERVIU","SMAPA","TRANSITO MUNICIPAL","TEP","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(j,{modelValue:u.value.Descripcion,"onUpdate:modelValue":e[14]||(e[14]=l=>u.value.Descripcion=l),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(S,{modelValue:u.value.Fecha_Creacion,"onUpdate:modelValue":e[15]||(e[15]=l=>u.value.Fecha_Creacion=l),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(K,null,{default:a(()=>[o(p,{color:"primary",onClick:de},{default:a(()=>[...e[39]||(e[39]=[s("Guardar",-1)])]),_:1}),o(p,{text:"",onClick:e[16]||(e[16]=l=>b.value=!1)},{default:a(()=>[...e[40]||(e[40]=[s("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(Y,{modelValue:M.value,"onUpdate:modelValue":e[22]||(e[22]=l=>M.value=l),persistent:"","max-width":"500px"},{default:a(()=>[o(g,null,{default:a(()=>[o(J,{class:"text-h5"},{default:a(()=>[...e[41]||(e[41]=[s("Editar un Proyecto",-1)])]),_:1}),o(q,null,{default:a(()=>[o(H,{ref:"formNuevoNudo"},{default:a(()=>[o(S,{modelValue:r.value.Nombre_Proyecto,"onUpdate:modelValue":e[18]||(e[18]=l=>r.value.Nombre_Proyecto=l),label:"Nombre Proyecto",outlined:"",dense:""},null,8,["modelValue"]),o(S,{modelValue:r.value.Codigo,"onUpdate:modelValue":e[19]||(e[19]=l=>r.value.Codigo=l),label:"Codigo de Proyecto",outlined:"",dense:""},null,8,["modelValue"]),o(y,{modelValue:r.value.Monitor,"onUpdate:modelValue":e[20]||(e[20]=l=>r.value.Monitor=l),items:h,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(K,null,{default:a(()=>[o(p,{color:"primary",onClick:pe},{default:a(()=>[...e[42]||(e[42]=[s("Guardar",-1)])]),_:1}),o(p,{text:"",onClick:e[21]||(e[21]=l=>M.value=!1)},{default:a(()=>[...e[43]||(e[43]=[s("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(Y,{modelValue:I.value,"onUpdate:modelValue":e[24]||(e[24]=l=>I.value=l),"max-width":"420"},{default:a(()=>[o(g,null,{default:a(()=>[o(J,{class:"text-h6"},{default:a(()=>[...e[44]||(e[44]=[s("Confirmar eliminación",-1)])]),_:1}),o(q,null,{default:a(()=>[...e[45]||(e[45]=[s("¿Estás seguro de que deseas eliminar este nudo?",-1)])]),_:1}),o(K,{class:"justify-end"},{default:a(()=>[o(p,{text:"",onClick:e[23]||(e[23]=l=>I.value=!1)},{default:a(()=>[...e[46]||(e[46]=[s("Cancelar",-1)])]),_:1}),o(p,{color:"error",onClick:Ve},{default:a(()=>[...e[47]||(e[47]=[s("Eliminar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},Fe=Te($e,[["__scopeId","data-v-e9f450f3"]]),je={__name:"index",setup(te){return(E,h)=>(m(),N(Fe))}};export{je as default};
