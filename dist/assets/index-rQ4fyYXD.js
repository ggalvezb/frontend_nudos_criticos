import{V as ve,a as ye,b as ge,c as y,d as z,e as k,f as M,g as R,h as J,i as q,j as H,u as B,w as Ve}from"./VTextarea-ChtcVcc_.js";import{_ as be,e as g,g as Ee,V as K,a as D,b as _,d as w,c as j,h as W,i as Q,j as X,f as Ne}from"./VTextField-CAdcEd-D.js";import{r as f,g as Z,h as _e,i as we,c as V,o as c,w as l,b as o,f as i,d as m,j as $,k as U,F as I,l as ee,t as x}from"./index-Cfbqr0v8.js";const xe={class:"mb-4"},De={class:"mb-4"},Ae={class:"lista-scroll"},Se={class:"mb-4"},he={class:"mb-4"},Pe={class:"text-subtitle-1"},Te={class:"lista-scroll"},Fe={__name:"Administrador",setup(oe){const b="https://backend-nudos-criticos-eadacb96aa89.herokuapp.com";function O(a){if(!a)return"";if(/^\d{2}-\d{2}-\d{4}$/.test(a)){const[t,p,E]=a.split("-");return`${E}-${p}-${t}`}const s=new Date(a.replaceAll("/","-"));return isNaN(s.getTime())?a:s.toISOString().slice(0,10)}async function te(){try{const a=await fetch(`${b}/proyecto/`);if(!a.ok)throw new Error(`Error obteniendo BD: ${a.status} ${a.statusText}`);const e=await a.json(),s=[];for(const n of e){const v=Array.isArray(n.Nudo_Critico)?n.Nudo_Critico:[];if(v.length===0)s.push({id_proyecto:n.id??"",Codigo:n.Codigo??"",Nombre_Proyecto:n.Nombre_Proyecto??"",Decreto:n.Decreto??"",Monitor:n.Monitor??"",id_nudo:"",Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:"",Fecha_Cierre:""});else for(const C of v)s.push({id_proyecto:n.id??"",Codigo:n.Codigo??"",Nombre_Proyecto:n.Nombre_Proyecto??"",Decreto:n.Decreto??"",Monitor:n.Monitor??"",id_nudo:C.id_nudo??"",Estado:C.Estado??"",Clasificacion:C.Clasificacion??"",Descripcion:C.Descripcion??"",Fecha_Creacion:O(C.Fecha_Creacion),Fecha_Cierre:O(C.Fecha_Cierre)})}s.sort((n,v)=>n.Estado===v.Estado?(v.Fecha_Creacion||"").localeCompare(n.Fecha_Creacion||""):n.Estado==="Abierto"?-1:1);const t=["id_proyecto","Codigo","Nombre_Proyecto","Decreto","Monitor","id_nudo","Estado","Clasificacion","Descripcion","Fecha_Creacion","Fecha_Cierre"],p=B.json_to_sheet(s,{header:t}),E=t.map(n=>({wch:Math.max(n.length,12)}));for(const n of s)t.forEach((v,C)=>{const Ce=n[v]==null?"":String(n[v]);E[C].wch=Math.max(E[C].wch,Ce.length)});p["!cols"]=E;const G=B.book_new();B.book_append_sheet(G,p,"NudosCriticos");const L=new Date,pe=`${L.getFullYear()}-${String(L.getMonth()+1).padStart(2,"0")}-${String(L.getDate()).padStart(2,"0")}`;Ve(G,`NudosCriticos_${pe}.xlsx`)}catch(a){console.error("Error al descargar Excel:",a),alert("No se pudo generar el Excel. Revisa la consola para más detalles.")}}const Y=["Todos","Carolina Espinosa","Macarena Guerra","Claudia Pastenes","Katherinne Rodriguez","Alejandra Lobos","Javiera Diaz","Javiera Caceres","Joel Cáceres"],ae=["Todas","AGUAS ANDINAS","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOM","ENEL","ENEL COLINA","IMIV","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],le=["Todos","Abierto","Resuelto"],A=f(!1),N=f(!1);function re(){const a=new Date,e=String(a.getDate()).padStart(2,"0"),s=String(a.getMonth()+1).padStart(2,"0"),t=a.getFullYear();return`${e}-${s}-${t}`}const u=f({Estado:"",Clasificacion:"",Descripcion:"",id_nudo:"",Fecha_Creacion:re()});async function se(){if(r.value){u.value.id_nudo=r.value.Codigo+"/"+r.value.Nudo_Critico.length,r.value.Nudo_Critico.push({...u.value});try{const e=await fetch(`${b}/proyecto/${encodeURIComponent(r.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!e.ok){const s=await e.text().catch(()=>"");throw new Error(`PATCH falló: ${e.status} ${e.statusText} ${s}`)}}catch(a){r.value.Nudo_Critico.pop(),N.value=!0,console.error("Error al agregar nudo crítico (BD):",a)}N.value=!1,console.log("Nuevo nudo crítico agregado:",u.value),u.value={Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:new Date().toISOString().split("T")[0]}}else console.log("Seleccione un proyecto antes de agregar un nudo crítico.")}const r=f(null),S=f(""),h=f("Todos"),P=f("Todas"),T=f("Todos"),d=f(null),ne=Z(()=>{let a=F.value;if(S.value){const e=S.value.toLowerCase();a=a.filter(s=>s.Nombre_Proyecto.toLowerCase().includes(e)||s.Codigo.toString().includes(e))}return h.value!=="Todos"&&(a=a.filter(e=>e.Monitor===h.value)),a}),ie=Z(()=>{if(!r.value)return[];let a=r.value.Nudo_Critico;return P.value!=="Todas"&&(a=a.filter(e=>e.Clasificacion===P.value)),T.value!=="Todos"&&(a=a.filter(e=>e.Estado===T.value)),a.sort((e,s)=>e.Estado===s.Estado?new Date(s.Fecha_Creacion)-new Date(e.Fecha_Creacion):e.Estado==="Abierto"?-1:1),a});function de(a){r.value=a,d.value=null}function ue(a){d.value={...a}}async function ce(){console.log("Cambios guardados");const a=r.value.Nudo_Critico.findIndex(e=>e.id_nudo===d.value.id_nudo);if(a===-1){console.error("No se encontró el nudo crítico en el proyecto.");return}r.value.Nudo_Critico[a]={...d.value},console.log("Nudo crítico actualizado en el proyecto");try{const e=await fetch(`${b}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!e.ok)throw new Error(`Error al actualizar el proyecto: ${e.statusText}`);const s=await e.json();console.log("Proyecto actualizado con éxito"),alert("Cambios guardados correctamente")}catch(e){console.error("Error al guardar cambios:",e),alert("Hubo un error al guardar los cambios, contacte al administrador.")}}async function me(){console.log("Proyecto editado:",r.value);try{const a=await fetch(`${b}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!a.ok)throw new Error(`Error al actualizar el proyecto: ${a.statusText}`);const e=await a.json();console.log("Proyecto actualizado con éxito"),alert("Proyecto actualizado correctamente"),A.value=!1}catch(a){console.error("Error al guardar cambios del proyecto:",a),alert("Hubo un error al guardar los cambios del proyecto, contacte al administrador.")}}const F=f([]);async function fe(){try{const a=await fetch(`${b}/proyecto/`);if(!a.ok)throw new Error(`Error al obtener proyectos: ${a.statusText}`);const e=await a.json();F.value=JSON.parse(JSON.stringify(e))}catch(a){console.error("Error al obtener los proyectos:",a)}}return _e(()=>{console.log("API_BASE: ",b),fe()}),(a,e)=>{const s=we("v-list-item-content");return c(),V(Ne,{class:"fill-height pa-0",fluid:"",style:{padding:"0","max-width":"100% !important","background-color":"#f5f5f5"}},{default:l(()=>[o(ve,{color:"primary",dark:""},{default:l(()=>[o(ye,null,{default:l(()=>[...e[22]||(e[22]=[i("Sistema de Registro de Nudos Críticos - Administrador",-1)])]),_:1}),o(ge),o(g,{color:"secondary",variant:"elevated",onClick:te},{default:l(()=>[o(Ee,{left:""},{default:l(()=>[...e[23]||(e[23]=[i("mdi-download",-1)])]),_:1}),e[24]||(e[24]=i(" Descargar Excel ",-1))]),_:1})]),_:1}),o(K,null,{default:l(()=>[o(D,{cols:"12",md:"4"},{default:l(()=>[o(_,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[26]||(e[26]=m("h2",{class:"text-h5 font-weight-bold"},"Proyectos",-1)),m("div",xe,[o(w,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=t=>S.value=t),label:"Buscar Proyecto",placeholder:"Nombre o Código",outlined:"",dense:""},null,8,["modelValue"])]),m("div",De,[o(y,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=t=>h.value=t),items:Y,label:"Filtrar por Monitor",outlined:"",dense:""},null,8,["modelValue"])]),m("div",Ae,[o(z,null,{default:l(()=>[(c(!0),$(I,null,ee(ne.value,(t,p)=>(c(),$(I,{key:t.id},[o(k,{onClick:E=>de(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(M,{class:"text-h6"},{default:l(()=>[i(x(t.Nombre_Proyecto),1)]),_:2},1024),o(R,null,{default:l(()=>[i("Código: "+x(t.Codigo),1)]),_:2},1024),o(R,null,{default:l(()=>[i("Monitor: "+x(t.Monitor),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),p<F.value.length-1?(c(),V(J,{key:0})):U("",!0)],64))),128)),F.value.length===0?(c(),V(k,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(M,{class:"text-h6"},{default:l(()=>[...e[25]||(e[25]=[i("No hay proyectos registrados.",-1)])]),_:1})]),_:1})]),_:1})):U("",!0)]),_:1})])]),_:1})]),_:1}),o(D,{cols:"12",md:"4"},{default:l(()=>[o(_,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[o(K,{class:"align-center justify-space-between"},{default:l(()=>[o(D,{cols:"12",md:"4",class:"d-flex align-center"},{default:l(()=>[...e[27]||(e[27]=[m("h2",{class:"text-h5 font-weight-bold mb-0"},"Nudos Críticos",-1)])]),_:1}),o(D,{cols:"12",md:"8",class:"d-flex justify-end flex-wrap"},{default:l(()=>[o(g,{color:"primary",class:"mb-2 mr-2",onClick:e[2]||(e[2]=t=>N.value=!0)},{default:l(()=>[...e[28]||(e[28]=[i(" NUEVO NUDO ",-1)])]),_:1}),o(g,{color:"primary",class:"mb-2",onClick:e[3]||(e[3]=t=>a.dialogoEditarProyecto=!0)},{default:l(()=>[...e[29]||(e[29]=[i(" EDITAR PROYECTO ",-1)])]),_:1})]),_:1})]),_:1}),m("div",Se,[o(y,{modelValue:T.value,"onUpdate:modelValue":e[4]||(e[4]=t=>T.value=t),items:le,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),m("div",he,[o(y,{modelValue:P.value,"onUpdate:modelValue":e[5]||(e[5]=t=>P.value=t),items:ae,label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"])]),m("p",Pe,"Proyecto: "+x(r.value?.Nombre_Proyecto||"Seleccione un proyecto"),1),m("div",Te,[o(z,null,{default:l(()=>[(c(!0),$(I,null,ee(ie.value,(t,p)=>(c(),$(I,{key:p},[o(k,{onClick:E=>ue(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(M,{class:"text-h6"},{default:l(()=>[i("Estado: "+x(t.Estado),1)]),_:2},1024),o(R,null,{default:l(()=>[i("Clasificación: "+x(t.Clasificacion),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),p<r.value.Nudo_Critico.length-1?(c(),V(J,{key:0})):U("",!0)],64))),128)),!r.value||r.value.Nudo_Critico.length===0?(c(),V(k,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(M,{class:"text-h6"},{default:l(()=>[...e[30]||(e[30]=[i("No hay nudos críticos registrados.",-1)])]),_:1})]),_:1})]),_:1})):U("",!0)]),_:1})])]),_:1})]),_:1}),o(D,{cols:"12",md:"4"},{default:l(()=>[d.value?(c(),V(_,{key:0,class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[32]||(e[32]=m("h2",{class:"text-h5 font-weight-bold"},"Detalle del Nudo Crítico",-1)),o(j,{ref:"form"},{default:l(()=>[o(y,{modelValue:d.value.Estado,"onUpdate:modelValue":e[6]||(e[6]=t=>d.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(y,{modelValue:d.value.Clasificacion,"onUpdate:modelValue":e[7]||(e[7]=t=>d.value.Clasificacion=t),items:["ENEL","Aguas Andinas","SEREMI"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(q,{modelValue:d.value.Descripcion,"onUpdate:modelValue":e[8]||(e[8]=t=>d.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(w,{modelValue:d.value.Fecha_Creacion,"onUpdate:modelValue":e[9]||(e[9]=t=>d.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"]),o(w,{modelValue:d.value.Fecha_Cierre,"onUpdate:modelValue":e[10]||(e[10]=t=>d.value.Fecha_Cierre=t),label:"Fecha de Cierre",outlined:"",dense:""},null,8,["modelValue"]),o(g,{color:"primary",class:"mt-4",onClick:ce},{default:l(()=>[...e[31]||(e[31]=[i("Guardar Cambios",-1)])]),_:1})]),_:1},512)]),_:1})):(c(),V(_,{key:1,class:"pa-4",style:{height:"100%"}},{default:l(()=>[...e[33]||(e[33]=[m("h2",{class:"text-h5 font-weight-bold"},"Seleccione un Nudo Crítico",-1)])]),_:1}))]),_:1})]),_:1}),o(H,{modelValue:N.value,"onUpdate:modelValue":e[16]||(e[16]=t=>N.value=t),persistent:"","max-width":"500px"},{default:l(()=>[o(_,null,{default:l(()=>[o(W,{class:"text-h5"},{default:l(()=>[...e[34]||(e[34]=[i("Agregar Nuevo Nudo Crítico",-1)])]),_:1}),o(Q,null,{default:l(()=>[o(j,{ref:"formNuevoNudo"},{default:l(()=>[o(y,{modelValue:u.value.Estado,"onUpdate:modelValue":e[11]||(e[11]=t=>u.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(y,{modelValue:u.value.Clasificacion,"onUpdate:modelValue":e[12]||(e[12]=t=>u.value.Clasificacion=t),items:["AGUAS ANDINAS","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOM","ENEL","ENEL COLINA","IMIV","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(q,{modelValue:u.value.Descripcion,"onUpdate:modelValue":e[13]||(e[13]=t=>u.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(w,{modelValue:u.value.Fecha_Creacion,"onUpdate:modelValue":e[14]||(e[14]=t=>u.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(X,null,{default:l(()=>[o(g,{color:"primary",onClick:se},{default:l(()=>[...e[35]||(e[35]=[i("Guardar",-1)])]),_:1}),o(g,{text:"",onClick:e[15]||(e[15]=t=>N.value=!1)},{default:l(()=>[...e[36]||(e[36]=[i("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(H,{modelValue:A.value,"onUpdate:modelValue":e[21]||(e[21]=t=>A.value=t),persistent:"","max-width":"500px"},{default:l(()=>[o(_,null,{default:l(()=>[o(W,{class:"text-h5"},{default:l(()=>[...e[37]||(e[37]=[i("Editar un Proyecto",-1)])]),_:1}),o(Q,null,{default:l(()=>[o(j,{ref:"formNuevoNudo"},{default:l(()=>[o(w,{modelValue:r.value.Nombre_Proyecto,"onUpdate:modelValue":e[17]||(e[17]=t=>r.value.Nombre_Proyecto=t),label:"Nombre Proyecto",outlined:"",dense:""},null,8,["modelValue"]),o(w,{modelValue:r.value.Codigo,"onUpdate:modelValue":e[18]||(e[18]=t=>r.value.Codigo=t),label:"Codigo de Proyecto",outlined:"",dense:""},null,8,["modelValue"]),o(y,{modelValue:r.value.Monitor,"onUpdate:modelValue":e[19]||(e[19]=t=>r.value.Monitor=t),items:Y,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(X,null,{default:l(()=>[o(g,{color:"primary",onClick:me},{default:l(()=>[...e[38]||(e[38]=[i("Guardar",-1)])]),_:1}),o(g,{text:"",onClick:e[20]||(e[20]=t=>A.value=!1)},{default:l(()=>[...e[39]||(e[39]=[i("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},ke=be(Fe,[["__scopeId","data-v-8679d4f1"]]),Ie={__name:"index",setup(oe){return(b,O)=>(c(),V(ke))}};export{Ie as default};
