import{V as de,a as ue,b as ce,c as V,d as Y,e as T,f as x,g as R,h as j,i as U,j as fe,u as L,w as me}from"./VTextarea-DxuuuLA0.js";import{_ as Ce,e as b,g as pe,V as ve,a as B,b as A,d as F,c as J,h as ge,i as _e,j as Ve,f as Ee}from"./VTextField-LtDxgmq0.js";import{r as p,g as z,h as ye,i as Ne,c as g,o as f,w as l,b as o,f as d,d as c,j as I,k as P,F as k,l as H,t as N}from"./index-CfKXi3iE.js";const be={class:"mb-4"},Ae={class:"mb-4"},De={class:"lista-scroll"},he={class:"d-flex justify-space-between align-center"},Se={class:"mb-4"},we={class:"mb-4"},Me={class:"text-subtitle-1"},Te={class:"lista-scroll"},xe={__name:"Inicio",setup(q){const E="https://backend-nudos-criticos-eadacb96aa89.herokuapp.com";function O(a){if(!a)return"";if(/^\d{2}-\d{2}-\d{4}$/.test(a)){const[t,m,_]=a.split("-");return`${_}-${m}-${t}`}const s=new Date(a.replaceAll("/","-"));return isNaN(s.getTime())?a:s.toISOString().slice(0,10)}async function K(){try{const a=await fetch(`${E}/proyecto/`);if(!a.ok)throw new Error(`Error obteniendo BD: ${a.status} ${a.statusText}`);const e=await a.json(),s=[];for(const r of e){const v=Array.isArray(r.Nudo_Critico)?r.Nudo_Critico:[];if(v.length===0)s.push({id_proyecto:r.id??"",Codigo:r.Codigo??"",Nombre_Proyecto:r.Nombre_Proyecto??"",Decreto:r.Decreto??"",Monitor:r.Monitor??"",id_nudo:"",Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:"",Fecha_Cierre:""});else for(const C of v)s.push({id_proyecto:r.id??"",Codigo:r.Codigo??"",Nombre_Proyecto:r.Nombre_Proyecto??"",Decreto:r.Decreto??"",Monitor:r.Monitor??"",id_nudo:C.id_nudo??"",Estado:C.Estado??"",Clasificacion:C.Clasificacion??"",Descripcion:C.Descripcion??"",Fecha_Creacion:O(C.Fecha_Creacion),Fecha_Cierre:O(C.Fecha_Cierre)})}s.sort((r,v)=>r.Estado===v.Estado?(v.Fecha_Creacion||"").localeCompare(r.Fecha_Creacion||""):r.Estado==="Abierto"?-1:1);const t=["id_proyecto","Codigo","Nombre_Proyecto","Decreto","Monitor","id_nudo","Estado","Clasificacion","Descripcion","Fecha_Creacion","Fecha_Cierre"],m=L.json_to_sheet(s,{header:t}),_=t.map(r=>({wch:Math.max(r.length,12)}));for(const r of s)t.forEach((v,C)=>{const ie=r[v]==null?"":String(r[v]);_[C].wch=Math.max(_[C].wch,ie.length)});m["!cols"]=_;const G=L.book_new();L.book_append_sheet(G,m,"NudosCriticos");const $=new Date,ne=`${$.getFullYear()}-${String($.getMonth()+1).padStart(2,"0")}-${String($.getDate()).padStart(2,"0")}`;me(G,`NudosCriticos_${ne}.xlsx`)}catch(a){console.error("Error al descargar Excel:",a),alert("No se pudo generar el Excel. Revisa la consola para más detalles.")}}const W=["Todos","Carolina Espinosa","Macarena Guerra","Claudia Pastenes","Katherinne Rodriguez","Alejandra Lobos","Javiera Diaz","Javiera Caceres","Joel Cáceres"],Q=["Todas","AGUAS ANDINAS","APR","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],X=["Todos","Abierto","Resuelto"],y=p(!1);function Z(){const a=new Date,e=String(a.getDate()).padStart(2,"0"),s=String(a.getMonth()+1).padStart(2,"0"),t=a.getFullYear();return`${e}-${s}-${t}`}const u=p({Estado:"",Clasificacion:"",Descripcion:"",id_nudo:"",Fecha_Creacion:Z()});async function ee(){if(n.value){u.value.id_nudo=n.value.Codigo+"/"+n.value.Nudo_Critico.length,n.value.Nudo_Critico.push({...u.value});try{const e=await fetch(`${E}/proyecto/${encodeURIComponent(n.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n.value)});if(!e.ok){const s=await e.text().catch(()=>"");throw new Error(`PATCH falló: ${e.status} ${e.statusText} ${s}`)}}catch(a){n.value.Nudo_Critico.pop(),y.value=!0,console.error("Error al agregar nudo crítico (BD):",a)}y.value=!1,console.log("Nuevo nudo crítico agregado:",u.value),u.value={Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:new Date().toISOString().split("T")[0]}}else console.log("Seleccione un proyecto antes de agregar un nudo crítico.")}const n=p(null),D=p(""),h=p("Todos"),S=p("Todas"),w=p("Todos"),i=p(null),oe=z(()=>{let a=M.value;if(D.value){const e=D.value.toLowerCase();a=a.filter(s=>s.Nombre_Proyecto.toLowerCase().includes(e)||s.Codigo.toString().includes(e))}return h.value!=="Todos"&&(a=a.filter(e=>e.Monitor===h.value)),a}),te=z(()=>{if(!n.value)return[];let a=n.value.Nudo_Critico;return S.value!=="Todas"&&(a=a.filter(e=>e.Clasificacion===S.value)),w.value!=="Todos"&&(a=a.filter(e=>e.Estado===w.value)),a.sort((e,s)=>e.Estado===s.Estado?new Date(s.Fecha_Creacion)-new Date(e.Fecha_Creacion):e.Estado==="Abierto"?-1:1),a});function ae(a){n.value=a,i.value=null}function le(a){i.value={...a}}async function se(){console.log("Cambios guardados");const a=n.value.Nudo_Critico.findIndex(e=>e.id_nudo===i.value.id_nudo);if(a===-1){console.error("No se encontró el nudo crítico en el proyecto.");return}n.value.Nudo_Critico[a]={...i.value},console.log("Nudo crítico actualizado en el proyecto");try{const e=await fetch(`${E}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n.value)});if(!e.ok)throw new Error(`Error al actualizar el proyecto: ${e.statusText}`);const s=await e.json();console.log("Proyecto actualizado con éxito"),alert("Cambios guardados correctamente")}catch(e){console.error("Error al guardar cambios:",e),alert("Hubo un error al guardar los cambios, contacte al administrador.")}}const M=p([]);async function re(){try{const a=await fetch(`${E}/proyecto/`);if(!a.ok)throw new Error(`Error al obtener proyectos: ${a.statusText}`);const e=await a.json();M.value=JSON.parse(JSON.stringify(e))}catch(a){console.error("Error al obtener los proyectos:",a)}}return ye(()=>{console.log("API_BASE: ",E),re()}),(a,e)=>{const s=Ne("v-list-item-content");return f(),g(Ee,{class:"fill-height pa-0",fluid:"",style:{padding:"0","max-width":"100% !important","background-color":"#f5f5f5"}},{default:l(()=>[o(de,{color:"primary",dark:""},{default:l(()=>[o(ue,null,{default:l(()=>[...e[17]||(e[17]=[d("Sistema de Registro de Nudos Críticos",-1)])]),_:1}),o(ce),o(b,{color:"secondary",variant:"elevated",onClick:K},{default:l(()=>[o(pe,{left:""},{default:l(()=>[...e[18]||(e[18]=[d("mdi-download",-1)])]),_:1}),e[19]||(e[19]=d(" Descargar Excel ",-1))]),_:1})]),_:1}),o(ve,null,{default:l(()=>[o(B,{cols:"12",md:"4"},{default:l(()=>[o(A,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[21]||(e[21]=c("h2",{class:"text-h5 font-weight-bold"},"Proyectos",-1)),c("div",be,[o(F,{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=t=>D.value=t),label:"Buscar Proyecto",placeholder:"Nombre o Código",outlined:"",dense:""},null,8,["modelValue"])]),c("div",Ae,[o(V,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=t=>h.value=t),items:W,label:"Filtrar por Monitor",outlined:"",dense:""},null,8,["modelValue"])]),c("div",De,[o(Y,null,{default:l(()=>[(f(!0),I(k,null,H(oe.value,(t,m)=>(f(),I(k,{key:t.id},[o(T,{onClick:_=>ae(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(x,{class:"text-h6"},{default:l(()=>[d(N(t.Nombre_Proyecto),1)]),_:2},1024),o(R,null,{default:l(()=>[d("Código: "+N(t.Codigo),1)]),_:2},1024),o(R,null,{default:l(()=>[d("Monitor: "+N(t.Monitor),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),m<M.value.length-1?(f(),g(j,{key:0})):P("",!0)],64))),128)),M.value.length===0?(f(),g(T,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(x,{class:"text-h6"},{default:l(()=>[...e[20]||(e[20]=[d("No hay proyectos registrados.",-1)])]),_:1})]),_:1})]),_:1})):P("",!0)]),_:1})])]),_:1})]),_:1}),o(B,{cols:"12",md:"4"},{default:l(()=>[o(A,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[c("div",he,[e[23]||(e[23]=c("h2",{class:"text-h5 font-weight-bold"},"Nudos Críticos",-1)),o(b,{color:"primary",onClick:e[2]||(e[2]=t=>y.value=!0)},{default:l(()=>[...e[22]||(e[22]=[d("Nuevo Nudo",-1)])]),_:1})]),c("div",Se,[o(V,{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=t=>w.value=t),items:X,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),c("div",we,[o(V,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=t=>S.value=t),items:Q,label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"])]),c("p",Me,"Proyecto: "+N(n.value?.Nombre_Proyecto||"Seleccione un proyecto"),1),c("div",Te,[o(Y,null,{default:l(()=>[(f(!0),I(k,null,H(te.value,(t,m)=>(f(),I(k,{key:m},[o(T,{onClick:_=>le(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(x,{class:"text-h6"},{default:l(()=>[d("Estado: "+N(t.Estado),1)]),_:2},1024),o(R,null,{default:l(()=>[d("Clasificación: "+N(t.Clasificacion),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),m<n.value.Nudo_Critico.length-1?(f(),g(j,{key:0})):P("",!0)],64))),128)),!n.value||n.value.Nudo_Critico.length===0?(f(),g(T,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(x,{class:"text-h6"},{default:l(()=>[...e[24]||(e[24]=[d("No hay nudos críticos registrados.",-1)])]),_:1})]),_:1})]),_:1})):P("",!0)]),_:1})])]),_:1})]),_:1}),o(B,{cols:"12",md:"4"},{default:l(()=>[i.value?(f(),g(A,{key:0,class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[26]||(e[26]=c("h2",{class:"text-h5 font-weight-bold"},"Detalle del Nudo Crítico",-1)),o(J,{ref:"form"},{default:l(()=>[o(V,{modelValue:i.value.Estado,"onUpdate:modelValue":e[5]||(e[5]=t=>i.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(V,{modelValue:i.value.Clasificacion,"onUpdate:modelValue":e[6]||(e[6]=t=>i.value.Clasificacion=t),items:["AGUAS ANDINAS","APR","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(U,{modelValue:i.value.Descripcion,"onUpdate:modelValue":e[7]||(e[7]=t=>i.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(U,{modelValue:i.value.Informacion_Adicional,"onUpdate:modelValue":e[8]||(e[8]=t=>i.value.Informacion_Adicional=t),label:"Información Adicional",outlined:"",dense:""},null,8,["modelValue"]),o(F,{modelValue:i.value.Fecha_Creacion,"onUpdate:modelValue":e[9]||(e[9]=t=>i.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"]),o(F,{modelValue:i.value.Fecha_Cierre,"onUpdate:modelValue":e[10]||(e[10]=t=>i.value.Fecha_Cierre=t),label:"Fecha de Cierre",outlined:"",dense:""},null,8,["modelValue"]),o(b,{color:"primary",class:"mt-4",onClick:se},{default:l(()=>[...e[25]||(e[25]=[d("Guardar Cambios",-1)])]),_:1})]),_:1},512)]),_:1})):(f(),g(A,{key:1,class:"pa-4",style:{height:"100%"}},{default:l(()=>[...e[27]||(e[27]=[c("h2",{class:"text-h5 font-weight-bold"},"Seleccione un Nudo Crítico",-1)])]),_:1}))]),_:1})]),_:1}),o(fe,{modelValue:y.value,"onUpdate:modelValue":e[16]||(e[16]=t=>y.value=t),persistent:"","max-width":"500px"},{default:l(()=>[o(A,null,{default:l(()=>[o(ge,{class:"text-h5"},{default:l(()=>[...e[28]||(e[28]=[d("Agregar Nuevo Nudo Crítico",-1)])]),_:1}),o(_e,null,{default:l(()=>[o(J,{ref:"formNuevoNudo"},{default:l(()=>[o(V,{modelValue:u.value.Estado,"onUpdate:modelValue":e[11]||(e[11]=t=>u.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(V,{modelValue:u.value.Clasificacion,"onUpdate:modelValue":e[12]||(e[12]=t=>u.value.Clasificacion=t),items:["AGUAS ANDINAS","APR","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(U,{modelValue:u.value.Descripcion,"onUpdate:modelValue":e[13]||(e[13]=t=>u.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(F,{modelValue:u.value.Fecha_Creacion,"onUpdate:modelValue":e[14]||(e[14]=t=>u.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(Ve,null,{default:l(()=>[o(b,{color:"primary",onClick:ee},{default:l(()=>[...e[29]||(e[29]=[d("Guardar",-1)])]),_:1}),o(b,{text:"",onClick:e[15]||(e[15]=t=>y.value=!1)},{default:l(()=>[...e[30]||(e[30]=[d("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},Fe=Ce(xe,[["__scopeId","data-v-72e9a516"]]),Oe={__name:"index",setup(q){return(E,O)=>(f(),g(Fe))}};export{Oe as default};
