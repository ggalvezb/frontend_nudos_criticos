import{V as de,a as ue,b as ce,c as V,d as Y,e as h,f as O,g as F,h as j,i as k,j as Ce,u as $,w as fe}from"./VTextarea-Vp5RFEAQ.js";import{_ as me,e as D,g as pe,V as Ae,a as B,b as S,d as R,c as J,h as ve,i as Ee,j as Ve,f as Ne}from"./VTextField-BRAEGQPQ.js";import{r as p,g as z,h as ge,i as _e,c as v,o as C,w as l,b as o,f as d,d as c,j as P,k as w,F as x,l as H,t as _}from"./index-ClB84Hoa.js";const De={class:"mb-4"},Se={class:"mb-4"},ye={class:"lista-scroll"},Ie={class:"d-flex justify-space-between align-center"},Me={class:"mb-4"},be={class:"mb-4"},Te={class:"text-subtitle-1"},he={class:"lista-scroll"},Oe={__name:"Inicio",setup(q){const N="https://backend-nudos-criticos-eadacb96aa89.herokuapp.com";function L(a){if(!a)return"";if(/^\d{2}-\d{2}-\d{4}$/.test(a)){const[t,f,E]=a.split("-");return`${E}-${f}-${t}`}const s=new Date(a.replaceAll("/","-"));return isNaN(s.getTime())?a:s.toISOString().slice(0,10)}async function K(){try{const a=await fetch(`${N}/proyecto/`);if(!a.ok)throw new Error(`Error obteniendo BD: ${a.status} ${a.statusText}`);const e=await a.json(),s=[];for(const r of e){const A=Array.isArray(r.Nudo_Critico)?r.Nudo_Critico:[];if(A.length===0)s.push({id_proyecto:r.id??"",Codigo:r.Codigo??"",Nombre_Proyecto:r.Nombre_Proyecto??"",Decreto:r.Decreto??"",Monitor:r.Monitor??"",id_nudo:"",Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:"",Fecha_Cierre:""});else for(const m of A)s.push({id_proyecto:r.id??"",Codigo:r.Codigo??"",Nombre_Proyecto:r.Nombre_Proyecto??"",Decreto:r.Decreto??"",Monitor:r.Monitor??"",id_nudo:m.id_nudo??"",Estado:m.Estado??"",Clasificacion:m.Clasificacion??"",Descripcion:m.Descripcion??"",Fecha_Creacion:L(m.Fecha_Creacion),Fecha_Cierre:L(m.Fecha_Cierre)})}s.sort((r,A)=>r.Estado===A.Estado?(A.Fecha_Creacion||"").localeCompare(r.Fecha_Creacion||""):r.Estado==="Abierto"?-1:1);const t=["id_proyecto","Codigo","Nombre_Proyecto","Decreto","Monitor","id_nudo","Estado","Clasificacion","Descripcion","Fecha_Creacion","Fecha_Cierre"],f=$.json_to_sheet(s,{header:t}),E=t.map(r=>({wch:Math.max(r.length,12)}));for(const r of s)t.forEach((A,m)=>{const ie=r[A]==null?"":String(r[A]);E[m].wch=Math.max(E[m].wch,ie.length)});f["!cols"]=E;const G=$.book_new();$.book_append_sheet(G,f,"NudosCriticos");const U=new Date,ne=`${U.getFullYear()}-${String(U.getMonth()+1).padStart(2,"0")}-${String(U.getDate()).padStart(2,"0")}`;fe(G,`NudosCriticos_${ne}.xlsx`)}catch(a){console.error("Error al descargar Excel:",a),alert("No se pudo generar el Excel. Revisa la consola para más detalles.")}}const W=["Todos","Carolina Espinosa","Macarena Guerra","Claudia Pastenes","Katherinne Rodriguez","Alejandra Lobos","Javiera Diaz","Javiera Caceres","Joel Cáceres"],Q=["Todas","ALCANTARILLADO","AGUAS ANDINAS","ALUMBRADO PÚBLICO","APR","BOMBEROS","CGE","CNM","CONSTRUCTORA","DGA","DGAC","DIA","DIMAO","DIMAS","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MINVU","MOP","OBRA","PAVEL","SACYR","SEC","SEREMITT","SEREMI SALUD","SEREMI VIVIENDA","SERVIU","SMAPA","TRANSITO MUNICIPAL","TEP","UOCT"],X=["Todos","Abierto","Resuelto"],g=p(!1);function Z(){const a=new Date,e=String(a.getDate()).padStart(2,"0"),s=String(a.getMonth()+1).padStart(2,"0"),t=a.getFullYear();return`${e}-${s}-${t}`}const u=p({Estado:"",Clasificacion:"",Descripcion:"",id_nudo:"",Fecha_Creacion:Z()});async function ee(){if(n.value){u.value.id_nudo=n.value.Codigo+"/"+n.value.Nudo_Critico.length,n.value.Nudo_Critico.push({...u.value});try{const e=await fetch(`${N}/proyecto/${encodeURIComponent(n.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(n.value)});if(!e.ok){const s=await e.text().catch(()=>"");throw new Error(`PATCH falló: ${e.status} ${e.statusText} ${s}`)}}catch(a){n.value.Nudo_Critico.pop(),g.value=!0,console.error("Error al agregar nudo crítico (BD):",a)}g.value=!1,console.log("Nuevo nudo crítico agregado:",u.value),u.value={Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:new Date().toISOString().split("T")[0]}}else console.log("Seleccione un proyecto antes de agregar un nudo crítico.")}const n=p(null),y=p(""),I=p("Todos"),M=p("Todas"),b=p("Todos"),i=p(null),oe=z(()=>{let a=T.value;if(y.value){const e=y.value.toLowerCase();a=a.filter(s=>s.Nombre_Proyecto.toLowerCase().includes(e)||s.Codigo.toString().includes(e))}return I.value!=="Todos"&&(a=a.filter(e=>e.Monitor===I.value)),a}),te=z(()=>{if(!n.value)return[];let a=n.value.Nudo_Critico;return M.value!=="Todas"&&(a=a.filter(e=>e.Clasificacion===M.value)),b.value!=="Todos"&&(a=a.filter(e=>e.Estado===b.value)),a.sort((e,s)=>e.Estado===s.Estado?new Date(s.Fecha_Creacion)-new Date(e.Fecha_Creacion):e.Estado==="Abierto"?-1:1),a});function ae(a){n.value=a,i.value=null}function le(a){i.value={...a}}async function se(){console.log("Cambios guardados");const a=n.value.Nudo_Critico.findIndex(e=>e.id_nudo===i.value.id_nudo);if(a===-1){console.error("No se encontró el nudo crítico en el proyecto.");return}n.value.Nudo_Critico[a]={...i.value},console.log("Nudo crítico actualizado en el proyecto");try{const e=await fetch(`${N}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n.value)});if(!e.ok)throw new Error(`Error al actualizar el proyecto: ${e.statusText}`);const s=await e.json();console.log("Proyecto actualizado con éxito"),alert("Cambios guardados correctamente")}catch(e){console.error("Error al guardar cambios:",e),alert("Hubo un error al guardar los cambios, contacte al administrador.")}}const T=p([]);async function re(){try{const a=await fetch(`${N}/proyecto/`);if(!a.ok)throw new Error(`Error al obtener proyectos: ${a.statusText}`);const e=await a.json();T.value=JSON.parse(JSON.stringify(e))}catch(a){console.error("Error al obtener los proyectos:",a)}}return ge(()=>{console.log("API_BASE: ",N),re()}),(a,e)=>{const s=_e("v-list-item-content");return C(),v(Ne,{class:"fill-height pa-0",fluid:"",style:{padding:"0","max-width":"100% !important","background-color":"#f5f5f5"}},{default:l(()=>[o(de,{color:"primary",dark:""},{default:l(()=>[o(ue,null,{default:l(()=>[...e[17]||(e[17]=[d("Sistema de Registro de Nudos Críticos",-1)])]),_:1}),o(ce),o(D,{color:"secondary",variant:"elevated",onClick:K},{default:l(()=>[o(pe,{left:""},{default:l(()=>[...e[18]||(e[18]=[d("mdi-download",-1)])]),_:1}),e[19]||(e[19]=d(" Descargar Excel ",-1))]),_:1})]),_:1}),o(Ae,null,{default:l(()=>[o(B,{cols:"12",md:"4"},{default:l(()=>[o(S,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[21]||(e[21]=c("h2",{class:"text-h5 font-weight-bold"},"Proyectos",-1)),c("div",De,[o(R,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t),label:"Buscar Proyecto",placeholder:"Nombre o Código",outlined:"",dense:""},null,8,["modelValue"])]),c("div",Se,[o(V,{modelValue:I.value,"onUpdate:modelValue":e[1]||(e[1]=t=>I.value=t),items:W,label:"Filtrar por Monitor",outlined:"",dense:""},null,8,["modelValue"])]),c("div",ye,[o(Y,null,{default:l(()=>[(C(!0),P(x,null,H(oe.value,(t,f)=>(C(),P(x,{key:t.id},[o(h,{onClick:E=>ae(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(O,{class:"text-h6"},{default:l(()=>[d(_(t.Nombre_Proyecto),1)]),_:2},1024),o(F,null,{default:l(()=>[d("Código: "+_(t.Codigo),1)]),_:2},1024),o(F,null,{default:l(()=>[d("Monitor: "+_(t.Monitor),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),f<T.value.length-1?(C(),v(j,{key:0})):w("",!0)],64))),128)),T.value.length===0?(C(),v(h,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(O,{class:"text-h6"},{default:l(()=>[...e[20]||(e[20]=[d("No hay proyectos registrados.",-1)])]),_:1})]),_:1})]),_:1})):w("",!0)]),_:1})])]),_:1})]),_:1}),o(B,{cols:"12",md:"4"},{default:l(()=>[o(S,{class:"pa-4",style:{height:"100%"}},{default:l(()=>[c("div",Ie,[e[23]||(e[23]=c("h2",{class:"text-h5 font-weight-bold"},"Nudos Críticos",-1)),o(D,{color:"primary",onClick:e[2]||(e[2]=t=>g.value=!0)},{default:l(()=>[...e[22]||(e[22]=[d("Nuevo Nudo",-1)])]),_:1})]),c("div",Me,[o(V,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=t=>b.value=t),items:X,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),c("div",be,[o(V,{modelValue:M.value,"onUpdate:modelValue":e[4]||(e[4]=t=>M.value=t),items:Q,label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"])]),c("p",Te,"Proyecto: "+_(n.value?.Nombre_Proyecto||"Seleccione un proyecto"),1),c("div",he,[o(Y,null,{default:l(()=>[(C(!0),P(x,null,H(te.value,(t,f)=>(C(),P(x,{key:f},[o(h,{onClick:E=>le(t),class:"cursor-pointer"},{default:l(()=>[o(s,null,{default:l(()=>[o(O,{class:"text-h6"},{default:l(()=>[d("Estado: "+_(t.Estado),1)]),_:2},1024),o(F,null,{default:l(()=>[d("Clasificación: "+_(t.Clasificacion),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),f<n.value.Nudo_Critico.length-1?(C(),v(j,{key:0})):w("",!0)],64))),128)),!n.value||n.value.Nudo_Critico.length===0?(C(),v(h,{key:0},{default:l(()=>[o(s,null,{default:l(()=>[o(O,{class:"text-h6"},{default:l(()=>[...e[24]||(e[24]=[d("No hay nudos críticos registrados.",-1)])]),_:1})]),_:1})]),_:1})):w("",!0)]),_:1})])]),_:1})]),_:1}),o(B,{cols:"12",md:"4"},{default:l(()=>[i.value?(C(),v(S,{key:0,class:"pa-4",style:{height:"100%"}},{default:l(()=>[e[26]||(e[26]=c("h2",{class:"text-h5 font-weight-bold"},"Detalle del Nudo Crítico",-1)),o(J,{ref:"form"},{default:l(()=>[o(V,{modelValue:i.value.Estado,"onUpdate:modelValue":e[5]||(e[5]=t=>i.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(V,{modelValue:i.value.Clasificacion,"onUpdate:modelValue":e[6]||(e[6]=t=>i.value.Clasificacion=t),items:["ALCANTARILLADO","AGUAS ANDINAS","ALUMBRADO PÚBLICO","APR","BOMBEROS","CGE","CNM","CONSTRUCTORA","DGA","DGAC","DIA","DIMAO","DIMAS","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MINVU","MOP","OBRA","PAVEL","SACYR","SEC","SEREMITT","SEREMI SALUD","SEREMI VIVIENDA","SERVIU","SMAPA","TRANSITO MUNICIPAL","TEP","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(k,{modelValue:i.value.Descripcion,"onUpdate:modelValue":e[7]||(e[7]=t=>i.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(k,{modelValue:i.value.Informacion_Adicional,"onUpdate:modelValue":e[8]||(e[8]=t=>i.value.Informacion_Adicional=t),label:"Información Adicional",outlined:"",dense:""},null,8,["modelValue"]),o(R,{modelValue:i.value.Fecha_Creacion,"onUpdate:modelValue":e[9]||(e[9]=t=>i.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"]),o(R,{modelValue:i.value.Fecha_Cierre,"onUpdate:modelValue":e[10]||(e[10]=t=>i.value.Fecha_Cierre=t),label:"Fecha de Cierre",outlined:"",dense:""},null,8,["modelValue"]),o(D,{color:"primary",class:"mt-4",onClick:se},{default:l(()=>[...e[25]||(e[25]=[d("Guardar Cambios",-1)])]),_:1})]),_:1},512)]),_:1})):(C(),v(S,{key:1,class:"pa-4",style:{height:"100%"}},{default:l(()=>[...e[27]||(e[27]=[c("h2",{class:"text-h5 font-weight-bold"},"Seleccione un Nudo Crítico",-1)])]),_:1}))]),_:1})]),_:1}),o(Ce,{modelValue:g.value,"onUpdate:modelValue":e[16]||(e[16]=t=>g.value=t),persistent:"","max-width":"500px"},{default:l(()=>[o(S,null,{default:l(()=>[o(ve,{class:"text-h5"},{default:l(()=>[...e[28]||(e[28]=[d("Agregar Nuevo Nudo Crítico",-1)])]),_:1}),o(Ee,null,{default:l(()=>[o(J,{ref:"formNuevoNudo"},{default:l(()=>[o(V,{modelValue:u.value.Estado,"onUpdate:modelValue":e[11]||(e[11]=t=>u.value.Estado=t),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(V,{modelValue:u.value.Clasificacion,"onUpdate:modelValue":e[12]||(e[12]=t=>u.value.Clasificacion=t),items:["ALCANTARILLADO","AGUAS ANDINAS","ALUMBRADO PÚBLICO","APR","BOMBEROS","CGE","CNM","CONSTRUCTORA","DGA","DGAC","DIA","DIMAO","DIMAS","DOH","DOM","DTPM","ENEL","ENEL COLINA","IMIV","METRO GAS","MINVU","MOP","OBRA","PAVEL","SACYR","SEC","SEREMITT","SEREMI SALUD","SEREMI VIVIENDA","SERVIU","SMAPA","TRANSITO MUNICIPAL","TEP","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(k,{modelValue:u.value.Descripcion,"onUpdate:modelValue":e[13]||(e[13]=t=>u.value.Descripcion=t),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(R,{modelValue:u.value.Fecha_Creacion,"onUpdate:modelValue":e[14]||(e[14]=t=>u.value.Fecha_Creacion=t),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(Ve,null,{default:l(()=>[o(D,{color:"primary",onClick:ee},{default:l(()=>[...e[29]||(e[29]=[d("Guardar",-1)])]),_:1}),o(D,{text:"",onClick:e[15]||(e[15]=t=>g.value=!1)},{default:l(()=>[...e[30]||(e[30]=[d("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},Re=me(Oe,[["__scopeId","data-v-887d7a76"]]),Le={__name:"index",setup(q){return(N,L)=>(C(),v(Re))}};export{Le as default};
