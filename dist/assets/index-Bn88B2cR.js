import{r as c,g as X,h as Ne,i as _e,c as b,o as m,w as a,b as o,f as s,d as p,j as h,k as I,F as U,l as Z,t as x,e as xe}from"./index-FAnwaGYH.js";import{V as we,a as Ae,b as De,c as E,d as ee,e as O,f as R,g as j,h as oe,i as Y,j as G,u as z,w as Se}from"./VTextarea-BQlYenRT.js";import{_ as Te,e as C,g as le,V as ae,a as T,b as N,d as w,c as J,h as q,i as H,j as K,f as ke}from"./VTextField-Dv5U0Vqq.js";const $e={class:"mb-4"},Pe={class:"mb-4"},Fe={class:"lista-scroll"},Me={class:"mb-4"},he={class:"mb-4"},Ie={class:"text-subtitle-1"},Ue={class:"lista-scroll"},Oe={__name:"Administrador",setup(te){const y="https://backend-nudos-criticos-eadacb96aa89.herokuapp.com",L=["Todos","Carolina Espinosa","Macarena Guerra","Claudia Pastenes","Katherinne Rodriguez","Alejandra Lobos","Javiera Diaz","Javiera Caceres","Joel Cáceres"],re=["Todas","AGUAS ANDINAS","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOM","ENEL","ENEL COLINA","IMIV","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],ne=["Todos","Abierto","Resuelto"],r=c(null),k=c(""),$=c("Todos"),P=c("Todas"),F=c("Todos"),d=c(null),A=c(!1),D=c(null);function W(t){if(!t)return"";if(/^\d{2}-\d{2}-\d{4}$/.test(t)){const[l,f,g]=t.split("-");return`${g}-${f}-${l}`}const n=new Date(t.replaceAll("/","-"));return isNaN(n.getTime())?t:n.toISOString().slice(0,10)}async function se(){try{const t=await fetch(`${y}/proyecto/`);if(!t.ok)throw new Error(`Error obteniendo BD: ${t.status} ${t.statusText}`);const e=await t.json(),n=[];for(const i of e){const V=Array.isArray(i.Nudo_Critico)?i.Nudo_Critico:[];if(V.length===0)n.push({id_proyecto:i.id??"",Codigo:i.Codigo??"",Nombre_Proyecto:i.Nombre_Proyecto??"",Decreto:i.Decreto??"",Monitor:i.Monitor??"",id_nudo:"",Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:"",Fecha_Cierre:""});else for(const v of V)n.push({id_proyecto:i.id??"",Codigo:i.Codigo??"",Nombre_Proyecto:i.Nombre_Proyecto??"",Decreto:i.Decreto??"",Monitor:i.Monitor??"",id_nudo:v.id_nudo??"",Estado:v.Estado??"",Clasificacion:v.Clasificacion??"",Descripcion:v.Descripcion??"",Fecha_Creacion:W(v.Fecha_Creacion),Fecha_Cierre:W(v.Fecha_Cierre)})}n.sort((i,V)=>i.Estado===V.Estado?(V.Fecha_Creacion||"").localeCompare(i.Fecha_Creacion||""):i.Estado==="Abierto"?-1:1);const l=["id_proyecto","Codigo","Nombre_Proyecto","Decreto","Monitor","id_nudo","Estado","Clasificacion","Descripcion","Fecha_Creacion","Fecha_Cierre"],f=z.json_to_sheet(n,{header:l}),g=l.map(i=>({wch:Math.max(i.length,12)}));for(const i of n)l.forEach((V,v)=>{const be=i[V]==null?"":String(i[V]);g[v].wch=Math.max(g[v].wch,be.length)});f["!cols"]=g;const Q=z.book_new();z.book_append_sheet(Q,f,"NudosCriticos");const B=new Date,Ee=`${B.getFullYear()}-${String(B.getMonth()+1).padStart(2,"0")}-${String(B.getDate()).padStart(2,"0")}`;Se(Q,`NudosCriticos_${Ee}.xlsx`)}catch(t){console.error("Error al descargar Excel:",t),alert("No se pudo generar el Excel. Revisa la consola para más detalles.")}}const S=c(!1),_=c(!1);function ie(){const t=new Date,e=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),l=t.getFullYear();return`${e}-${n}-${l}`}const u=c({Estado:"",Clasificacion:"",Descripcion:"",id_nudo:"",Fecha_Creacion:ie()});async function de(){if(r.value){u.value.id_nudo=r.value.Codigo+"/"+r.value.Nudo_Critico.length,r.value.Nudo_Critico.push({...u.value});try{const e=await fetch(`${y}/proyecto/${encodeURIComponent(r.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!e.ok){const n=await e.text().catch(()=>"");throw new Error(`PATCH falló: ${e.status} ${e.statusText} ${n}`)}}catch(t){r.value.Nudo_Critico.pop(),_.value=!0,console.error("Error al agregar nudo crítico (BD):",t)}_.value=!1,console.log("Nuevo nudo crítico agregado:",u.value),u.value={Estado:"",Clasificacion:"",Descripcion:"",Fecha_Creacion:new Date().toISOString().split("T")[0]}}else console.log("Seleccione un proyecto antes de agregar un nudo crítico.")}const ue=X(()=>{let t=M.value;if(k.value){const e=k.value.toLowerCase();t=t.filter(n=>n.Nombre_Proyecto.toLowerCase().includes(e)||n.Codigo.toString().includes(e))}return $.value!=="Todos"&&(t=t.filter(e=>e.Monitor===$.value)),t}),ce=X(()=>{if(!r.value)return[];let t=r.value.Nudo_Critico;return P.value!=="Todas"&&(t=t.filter(e=>e.Clasificacion===P.value)),F.value!=="Todos"&&(t=t.filter(e=>e.Estado===F.value)),t.sort((e,n)=>e.Estado===n.Estado?new Date(n.Fecha_Creacion)-new Date(e.Fecha_Creacion):e.Estado==="Abierto"?-1:1),t});function me(t){r.value=t,d.value=null}function fe(t){d.value={...t}}async function pe(){console.log("Cambios guardados");const t=r.value.Nudo_Critico.findIndex(e=>e.id_nudo===d.value.id_nudo);if(t===-1){console.error("No se encontró el nudo crítico en el proyecto.");return}r.value.Nudo_Critico[t]={...d.value},console.log("Nudo crítico actualizado en el proyecto");try{const e=await fetch(`${y}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!e.ok)throw new Error(`Error al actualizar el proyecto: ${e.statusText}`);const n=await e.json();console.log("Proyecto actualizado con éxito"),alert("Cambios guardados correctamente")}catch(e){console.error("Error al guardar cambios:",e),alert("Hubo un error al guardar los cambios, contacte al administrador.")}}async function Ce(){console.log("Proyecto editado:",r.value);try{const t=await fetch(`${y}/proyecto/`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!t.ok)throw new Error(`Error al actualizar el proyecto: ${t.statusText}`);const e=await t.json();console.log("Proyecto actualizado con éxito"),alert("Proyecto actualizado correctamente"),S.value=!1}catch(t){console.error("Error al guardar cambios del proyecto:",t),alert("Hubo un error al guardar los cambios del proyecto, contacte al administrador.")}}const M=c([]);async function ve(){try{const t=await fetch(`${y}/proyecto/`);if(!t.ok)throw new Error(`Error al obtener proyectos: ${t.statusText}`);const e=await t.json();M.value=JSON.parse(JSON.stringify(e))}catch(t){console.error("Error al obtener los proyectos:",t)}}Ne(()=>{console.log("API_BASE: ",y),ve()});async function ye(t){if(!r.value)return;const e=r.value.Nudo_Critico.findIndex(n=>n.id_nudo===t.id_nudo);if(e!==-1){r.value.Nudo_Critico.splice(e,1);try{const l=await fetch(`${y}/proyecto/${encodeURIComponent(r.value.id)}/${encodeURIComponent("Nudo_Critico")}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.value)});if(!l.ok){const f=await l.text().catch(()=>"");throw new Error(`PATCH falló: ${l.status} ${l.statusText} ${f}`)}d.value&&d.value.id_nudo===t.id_nudo&&(d.value=null)}catch(n){console.error("Error al eliminar nudo crítico (BD):",n),alert("No se pudo eliminar el nudo crítico. Revisa la consola para más detalles.")}}}function ge(t){D.value=t,A.value=!0}async function Ve(){D.value&&(console.log("Se elimina proyecto:",D.value),await ye(D.value),A.value=!1,D.value=null)}return(t,e)=>{const n=_e("v-list-item-content");return m(),b(ke,{class:"fill-height pa-0",fluid:"",style:{padding:"0","max-width":"100% !important","background-color":"#f5f5f5"}},{default:a(()=>[o(we,{color:"primary",dark:""},{default:a(()=>[o(Ae,null,{default:a(()=>[...e[25]||(e[25]=[s("Sistema de Registro de Nudos Críticos - Administrador",-1)])]),_:1}),o(De),o(C,{color:"secondary",variant:"elevated",onClick:se},{default:a(()=>[o(le,{left:""},{default:a(()=>[...e[26]||(e[26]=[s("mdi-download",-1)])]),_:1}),e[27]||(e[27]=s(" Descargar Excel ",-1))]),_:1})]),_:1}),o(ae,null,{default:a(()=>[o(T,{cols:"12",md:"4"},{default:a(()=>[o(N,{class:"pa-4",style:{height:"100%"}},{default:a(()=>[e[29]||(e[29]=p("h2",{class:"text-h5 font-weight-bold"},"Proyectos",-1)),p("div",$e,[o(w,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=l=>k.value=l),label:"Buscar Proyecto",placeholder:"Nombre o Código",outlined:"",dense:""},null,8,["modelValue"])]),p("div",Pe,[o(E,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=l=>$.value=l),items:L,label:"Filtrar por Monitor",outlined:"",dense:""},null,8,["modelValue"])]),p("div",Fe,[o(ee,null,{default:a(()=>[(m(!0),h(U,null,Z(ue.value,(l,f)=>(m(),h(U,{key:l.id},[o(O,{onClick:g=>me(l),class:"cursor-pointer"},{default:a(()=>[o(n,null,{default:a(()=>[o(R,{class:"text-h6"},{default:a(()=>[s(x(l.Nombre_Proyecto),1)]),_:2},1024),o(j,null,{default:a(()=>[s("Código: "+x(l.Codigo),1)]),_:2},1024),o(j,null,{default:a(()=>[s("Monitor: "+x(l.Monitor),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),f<M.value.length-1?(m(),b(oe,{key:0})):I("",!0)],64))),128)),M.value.length===0?(m(),b(O,{key:0},{default:a(()=>[o(n,null,{default:a(()=>[o(R,{class:"text-h6"},{default:a(()=>[...e[28]||(e[28]=[s("No hay proyectos registrados.",-1)])]),_:1})]),_:1})]),_:1})):I("",!0)]),_:1})])]),_:1})]),_:1}),o(T,{cols:"12",md:"4"},{default:a(()=>[o(N,{class:"pa-4",style:{height:"100%"}},{default:a(()=>[o(ae,{class:"align-center justify-space-between"},{default:a(()=>[o(T,{cols:"12",md:"4",class:"d-flex align-center"},{default:a(()=>[...e[30]||(e[30]=[p("h2",{class:"text-h5 font-weight-bold mb-0"},"Nudos Críticos",-1)])]),_:1}),o(T,{cols:"12",md:"8",class:"d-flex justify-end flex-wrap"},{default:a(()=>[o(C,{color:"primary",class:"mb-2 mr-2",onClick:e[2]||(e[2]=l=>_.value=!0)},{default:a(()=>[...e[31]||(e[31]=[s(" NUEVO NUDO ",-1)])]),_:1}),o(C,{color:"primary",class:"mb-2",onClick:e[3]||(e[3]=l=>S.value=!0)},{default:a(()=>[...e[32]||(e[32]=[s(" EDITAR PROYECTO ",-1)])]),_:1})]),_:1})]),_:1}),p("div",Me,[o(E,{modelValue:F.value,"onUpdate:modelValue":e[4]||(e[4]=l=>F.value=l),items:ne,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),p("div",he,[o(E,{modelValue:P.value,"onUpdate:modelValue":e[5]||(e[5]=l=>P.value=l),items:re,label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"])]),p("p",Ie,"Proyecto: "+x(r.value?.Nombre_Proyecto||"Seleccione un proyecto"),1),p("div",Ue,[o(ee,null,{default:a(()=>[(m(!0),h(U,null,Z(ce.value,(l,f)=>(m(),h(U,{key:f},[o(O,{onClick:g=>fe(l),class:"cursor-pointer"},{append:a(()=>[o(le,{size:"22",color:"grey-darken-1",class:"mr-2 cursor-pointer",onClick:xe(g=>ge(l),["stop"])},{default:a(()=>[...e[33]||(e[33]=[s(" mdi-delete ",-1)])]),_:1},8,["onClick"])]),default:a(()=>[o(n,null,{default:a(()=>[o(R,{class:"text-h6"},{default:a(()=>[s("Estado: "+x(l.Estado),1)]),_:2},1024),o(j,null,{default:a(()=>[s("Clasificación: "+x(l.Clasificacion),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]),f<r.value.Nudo_Critico.length-1?(m(),b(oe,{key:0})):I("",!0)],64))),128)),!r.value||r.value.Nudo_Critico.length===0?(m(),b(O,{key:0},{default:a(()=>[o(n,null,{default:a(()=>[o(R,{class:"text-h6"},{default:a(()=>[...e[34]||(e[34]=[s("No hay nudos críticos registrados.",-1)])]),_:1})]),_:1})]),_:1})):I("",!0)]),_:1})])]),_:1})]),_:1}),o(T,{cols:"12",md:"4"},{default:a(()=>[d.value?(m(),b(N,{key:0,class:"pa-4",style:{height:"100%"}},{default:a(()=>[e[36]||(e[36]=p("h2",{class:"text-h5 font-weight-bold"},"Detalle del Nudo Crítico",-1)),o(J,{ref:"form"},{default:a(()=>[o(E,{modelValue:d.value.Estado,"onUpdate:modelValue":e[6]||(e[6]=l=>d.value.Estado=l),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(E,{modelValue:d.value.Clasificacion,"onUpdate:modelValue":e[7]||(e[7]=l=>d.value.Clasificacion=l),items:["ENEL","Aguas Andinas","SEREMI"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(Y,{modelValue:d.value.Descripcion,"onUpdate:modelValue":e[8]||(e[8]=l=>d.value.Descripcion=l),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(Y,{modelValue:d.value.Informacion_Adicional,"onUpdate:modelValue":e[9]||(e[9]=l=>d.value.Informacion_Adicional=l),label:"Información Adicional",outlined:"",dense:""},null,8,["modelValue"]),o(w,{modelValue:d.value.Fecha_Creacion,"onUpdate:modelValue":e[10]||(e[10]=l=>d.value.Fecha_Creacion=l),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"]),o(w,{modelValue:d.value.Fecha_Cierre,"onUpdate:modelValue":e[11]||(e[11]=l=>d.value.Fecha_Cierre=l),label:"Fecha de Cierre",outlined:"",dense:""},null,8,["modelValue"]),o(C,{color:"primary",class:"mt-4",onClick:pe},{default:a(()=>[...e[35]||(e[35]=[s("Guardar Cambios",-1)])]),_:1})]),_:1},512)]),_:1})):(m(),b(N,{key:1,class:"pa-4",style:{height:"100%"}},{default:a(()=>[...e[37]||(e[37]=[p("h2",{class:"text-h5 font-weight-bold"},"Seleccione un Nudo Crítico",-1)])]),_:1}))]),_:1})]),_:1}),o(G,{modelValue:_.value,"onUpdate:modelValue":e[17]||(e[17]=l=>_.value=l),persistent:"","max-width":"500px"},{default:a(()=>[o(N,null,{default:a(()=>[o(q,{class:"text-h5"},{default:a(()=>[...e[38]||(e[38]=[s("Agregar Nuevo Nudo Crítico",-1)])]),_:1}),o(H,null,{default:a(()=>[o(J,{ref:"formNuevoNudo"},{default:a(()=>[o(E,{modelValue:u.value.Estado,"onUpdate:modelValue":e[12]||(e[12]=l=>u.value.Estado=l),items:["Abierto","Resuelto"],label:"Estado",outlined:"",dense:""},null,8,["modelValue"]),o(E,{modelValue:u.value.Clasificacion,"onUpdate:modelValue":e[13]||(e[13]=l=>u.value.Clasificacion=l),items:["AGUAS ANDINAS","BOMBEROS","CGE","CNM","DGA","DGAC","DIA","DOM","ENEL","ENEL COLINA","IMIV","MOP","PAVEL","SACYR","SEC","SEREMITT","UOCT"],label:"Clasificación",outlined:"",dense:""},null,8,["modelValue"]),o(Y,{modelValue:u.value.Descripcion,"onUpdate:modelValue":e[14]||(e[14]=l=>u.value.Descripcion=l),label:"Descripción",outlined:"",dense:""},null,8,["modelValue"]),o(w,{modelValue:u.value.Fecha_Creacion,"onUpdate:modelValue":e[15]||(e[15]=l=>u.value.Fecha_Creacion=l),label:"Fecha de Creación",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(K,null,{default:a(()=>[o(C,{color:"primary",onClick:de},{default:a(()=>[...e[39]||(e[39]=[s("Guardar",-1)])]),_:1}),o(C,{text:"",onClick:e[16]||(e[16]=l=>_.value=!1)},{default:a(()=>[...e[40]||(e[40]=[s("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(G,{modelValue:S.value,"onUpdate:modelValue":e[22]||(e[22]=l=>S.value=l),persistent:"","max-width":"500px"},{default:a(()=>[o(N,null,{default:a(()=>[o(q,{class:"text-h5"},{default:a(()=>[...e[41]||(e[41]=[s("Editar un Proyecto",-1)])]),_:1}),o(H,null,{default:a(()=>[o(J,{ref:"formNuevoNudo"},{default:a(()=>[o(w,{modelValue:r.value.Nombre_Proyecto,"onUpdate:modelValue":e[18]||(e[18]=l=>r.value.Nombre_Proyecto=l),label:"Nombre Proyecto",outlined:"",dense:""},null,8,["modelValue"]),o(w,{modelValue:r.value.Codigo,"onUpdate:modelValue":e[19]||(e[19]=l=>r.value.Codigo=l),label:"Codigo de Proyecto",outlined:"",dense:""},null,8,["modelValue"]),o(E,{modelValue:r.value.Monitor,"onUpdate:modelValue":e[20]||(e[20]=l=>r.value.Monitor=l),items:L,label:"Estado",outlined:"",dense:""},null,8,["modelValue"])]),_:1},512)]),_:1}),o(K,null,{default:a(()=>[o(C,{color:"primary",onClick:Ce},{default:a(()=>[...e[42]||(e[42]=[s("Guardar",-1)])]),_:1}),o(C,{text:"",onClick:e[21]||(e[21]=l=>S.value=!1)},{default:a(()=>[...e[43]||(e[43]=[s("Cancelar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(G,{modelValue:A.value,"onUpdate:modelValue":e[24]||(e[24]=l=>A.value=l),"max-width":"420"},{default:a(()=>[o(N,null,{default:a(()=>[o(q,{class:"text-h6"},{default:a(()=>[...e[44]||(e[44]=[s("Confirmar eliminación",-1)])]),_:1}),o(H,null,{default:a(()=>[...e[45]||(e[45]=[s("¿Estás seguro de que deseas eliminar este nudo?",-1)])]),_:1}),o(K,{class:"justify-end"},{default:a(()=>[o(C,{text:"",onClick:e[23]||(e[23]=l=>A.value=!1)},{default:a(()=>[...e[46]||(e[46]=[s("Cancelar",-1)])]),_:1}),o(C,{color:"error",onClick:Ve},{default:a(()=>[...e[47]||(e[47]=[s("Eliminar",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},Re=Te(Oe,[["__scopeId","data-v-c77377f8"]]),Ye={__name:"index",setup(te){return(y,L)=>(m(),b(Re))}};export{Ye as default};
